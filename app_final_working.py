import streamlit as st
# import sqlite3  # âŒ Comentado - ya no se usa
from anthropic import Anthropic
from modules.database_supabase import SupabaseDatabase
# from modules.storage_supabase import SupabaseStorage  # âŒ Not used - using local storage
import os
from dotenv import load_dotenv
import tempfile
import uuid
import json
import shutil
import re
import hashlib
import traceback

try:
    import pdfplumber
    PDF_SUPPORT = True
except ImportError:
    PDF_SUPPORT = False

load_dotenv()

# Force redeploy - v3.1 - NISPACHIM EXPANDED - 60+ nispachim with web search
st.set_page_config(page_title="×”×©×•×•××ª ×¤×•×œ×™×¡×•×ª v3.1", page_icon="ğŸ“„", layout="wide")

st.markdown("""
<style>
    /* Global RTL for all content */
    .main .block-container { 
        direction: rtl !important; 
        text-align: right !important; 
    }
    
    /* All text elements */
    .stMarkdown, .stMarkdown p, .stMarkdown div, .stMarkdown li, .stMarkdown ul, .stMarkdown ol {
        direction: rtl !important;
        text-align: right !important;
    }
    
    /* Info boxes */
    .stAlert, .stInfo, .stSuccess, .stWarning, .stError {
        direction: rtl !important;
        text-align: right !important;
    }
    
    /* Expanders */
    .streamlit-expanderHeader, [data-testid="stExpander"] {
        direction: rtl !important;
        text-align: right !important;
    }
    
    [data-testid="stExpander"] > details > summary {
        text-align: right !important;
        direction: rtl !important;
    }
    
    [data-testid="stExpander"] > details > div {
        text-align: right !important;
        direction: rtl !important;
    }
    
    /* Text inputs and textareas */
    .stTextInput>div>div>input, .stTextArea>div>div>textarea { 
        text-align: right !important; 
        direction: rtl !important;
    }
    
    /* Headers */
    h1, h2, h3, h4, h5, h6 { 
        text-align: right !important; 
        direction: rtl !important;
    }
    
    /* Buttons */
    .stButton>button { 
        width: 100%; 
    }
    
    /* All paragraphs and divs */
    p, div, span, label {
        direction: rtl !important;
    }
</style>
""", unsafe_allow_html=True)

# Initialize session state
if 'authenticated' not in st.session_state:
    st.session_state.authenticated = False
if 'username' not in st.session_state:
    st.session_state.username = None
if 'user_id' not in st.session_state:
    st.session_state.user_id = None
if 'page' not in st.session_state:
    st.session_state.page = "ğŸ  ×‘×™×ª"
if 'current_investigation_id' not in st.session_state:
    st.session_state.current_investigation_id = None

COMPANIES = ["×”×¨××œ", "××’×“×œ", "×›×œ×œ", "×× ×•×¨×”", "×”×¤× ×™×§×¡", "××™×™×œ×•×Ÿ"]
UPLOAD_DIR = "policy_uploads"
os.makedirs(UPLOAD_DIR, exist_ok=True)

# Insurance Companies General Information
COMPANIES_INFO = {
    "×”×¨××œ": {
        "full_name": "×”×¨××œ ×—×‘×¨×” ×œ×‘×™×˜×•×— ×‘×¢\"×",
        "website": "www.harel-group.co.il",
        "phone": "*2407",
        "strengths": ["×—×‘×¨×” ×’×“×•×œ×” ×•××•×‘×™×œ×”", "×©×™×¨×•×ª ×œ×§×•×—×•×ª ×˜×•×‘", "×¨×©×ª ×¨×—×‘×” ×©×œ × ×•×ª× ×™ ×©×™×¨×•×ª"],
        "known_for": ["×‘×™×˜×•×— ×‘×¨×™××•×ª ××§×™×£", "××•×¦×¨×™ ×¤× ×¡×™×”", "×—×™×¡×›×•×Ÿ ×•×”×©×§×¢×•×ª"]
    },
    "××’×“×œ": {
        "full_name": "××’×“×œ ×—×‘×¨×” ×œ×‘×™×˜×•×— ×‘×¢\"×",
        "website": "www.migdal.co.il",
        "phone": "*2679",
        "strengths": ["×—×‘×¨×ª ×‘×™×˜×•×— ×•×¤×™× × ×¡×™× ××•×‘×™×œ×”", "××’×•×•×Ÿ ×¨×—×‘ ×©×œ ××•×¦×¨×™×", "×“×™×’×™×˜×¦×™×” ××ª×§×“××ª"],
        "known_for": ["×‘×™×˜×•×— ×—×™×™× ×•×‘×¨×™××•×ª", "×§×¨× ×•×ª ×¤× ×¡×™×”", "× ×™×”×•×œ ×ª×™×§×™×"]
    },
    "×›×œ×œ": {
        "full_name": "×›×œ×œ ×—×‘×¨×” ×œ×‘×™×˜×•×— ×‘×¢\"×",
        "website": "www.clalbit.co.il",
        "phone": "*2800",
        "strengths": ["×—×“×©× ×•×ª ×“×™×’×™×˜×œ×™×ª", "××•×¦×¨×™× ×™×™×—×•×“×™×™×", "×©×™×¨×•×ª ××”×™×¨"],
        "known_for": ["×‘×™×˜×•×— ×‘×¨×™××•×ª", "×‘×™×˜×•×— ×¨×›×‘", "×‘×™×˜×•×— ×“×™×¨×”"]
    },
    "×× ×•×¨×”": {
        "full_name": "×× ×•×¨×” ××‘×˜×—×™× ×‘×™×˜×•×— ×‘×¢\"×",
        "website": "www.menoramivt.co.il",
        "phone": "*2000",
        "strengths": ["××—×ª ×”×’×“×•×œ×•×ª ×‘×™×©×¨××œ", "×™×¦×™×‘×•×ª ×¤×™× × ×¡×™×ª", "××•× ×™×˜×™×Ÿ ×•×ª×™×§"],
        "known_for": ["×‘×™×˜×•×— ×—×™×™× ×•×‘×¨×™××•×ª", "×¤× ×¡×™×”", "×—×™×¡×›×•×Ÿ ×œ×˜×•×•×— ××¨×•×š"]
    },
    "×”×¤× ×™×§×¡": {
        "full_name": "×”×¤× ×™×§×¡ ×”×™×©×¨××œ×™ ×—×‘×¨×” ×œ×‘×™×˜×•×— ×‘×¢\"×",
        "website": "www.fnx.co.il",
        "phone": "*6836",
        "strengths": ["×—×“×©× ×•×ª", "××•×¦×¨×™× ××•×ª×××™× ××™×©×™×ª", "×©×™×¨×•×ª ×“×™×’×™×˜×œ×™"],
        "known_for": ["×‘×™×˜×•×— ×‘×¨×™××•×ª", "×‘×™×˜×•×— ×—×™×™×", "×¤× ×¡×™×”"]
    },
    "××™×™×œ×•×Ÿ": {
        "full_name": "××™×™×œ×•×Ÿ ×—×‘×¨×” ×œ×‘×™×˜×•×— ×‘×¢\"×",
        "website": "www.ayalon-ins.co.il",
        "phone": "*5620",
        "strengths": ["×—×‘×¨×ª ×‘×™×˜×•×— ×›×œ×œ×™", "××—×™×¨×™× ×ª×—×¨×•×ª×™×™×", "×©×™×¨×•×ª ××™×©×™"],
        "known_for": ["×‘×™×˜×•×— ×¨×›×‘", "×‘×™×˜×•×— ×‘×¨×™××•×ª", "×‘×™×˜×•×— ×“×™×¨×”"]
    }
}

# ============================================================================
# NISPACH (APPENDIX) INFORMATION DATABASE - EXPANDED VERSION (60+ nispachim)
# ============================================================================

NISPACH_INFO_EXPANDED = {
    # ===== NISPACHIM BÃSICOS (Ya existentes) =====
    "8713": {
        "name": "××‘×—× ×” ××”×™×¨×”",
        "description": "×›×ª×‘ ×©×™×¨×•×ª ×”×××¤×©×¨ ×’×™×©×” ××”×™×¨×” ×œ×‘×“×™×§×•×ª ×“×™××•×ª ×•×™×™×¢×•×¦×™× ×¨×¤×•××™×™×",
        "includes": ["×‘×“×™×§×•×ª CT ×•-MRI", "×‘×“×™×§×•×ª PET-CT", "×™×™×¢×•×¦×™× ××•××—×™×", "×‘×“×™×§×•×ª ××¢×‘×“×” ××•×¨×›×‘×•×ª"],
        "reimbursement": {
            "CT": "×”×—×–×¨ ××œ×",
            "MRI": "×”×—×–×¨ ××œ×",
            "PET-CT": "×”×—×–×¨ ××œ×",
            "×™×™×¢×•×¥ ××•××—×”": "×”×—×–×¨ ××œ×"
        },
        "limits": {"×©× ×ª×™": "×œ×œ× ×”×’×‘×œ×”", "×œ×‘×“×™×§×”": "×œ×œ× ××’×‘×œ×”"},
        "notes": "×œ×œ× ×ª×§×•×¤×ª ×”××ª× ×”, ×’×™×©×” ×™×©×™×¨×” ×œ××•××—×™×"
    },
    "5409": {
        "name": "× ×™×ª×•×—×™× ×‘×—×•\"×œ",
        "description": "×›×™×¡×•×™ ×œ×”×•×¦××•×ª × ×™×ª×•×— ×•××—×œ×™×¤×™ × ×™×ª×•×— ××—×•×¥ ×œ×™×©×¨××œ",
        "includes": ["×”×•×¦××•×ª × ×™×ª×•×—", "×˜×™×¡×•×ª", "××©×¤×•×–", "××œ×•×•×” ××—×“", "×”×—×–×¨ × ×¡×™×¢×•×ª"],
        "reimbursement": {
            "× ×™×ª×•×—": "×¢×“ ×ª×§×¨×ª ×”×¤×•×œ×™×¡×”",
            "×˜×™×¡×”": "×”×—×–×¨ ××œ×",
            "×œ×™× ×”": "×”×—×–×¨ ××œ×",
            "××œ×•×•×”": "×˜×™×¡×” + ×œ×™× ×”"
        },
        "limits": {"×©× ×ª×™": "×œ×¤×™ ×ª×§×¨×ª ×”×¤×•×œ×™×¡×”", "×œ× ×™×ª×•×—": "××©×ª× ×”"},
        "notes": "×›×¤×•×£ ×œ××™×©×•×¨ ××¨××© ××”×—×‘×¨×”"
    },
    "6792": {
        "name": "×¨×¤×•××” ××©×œ×™××”",
        "description": "×›×ª×‘ ×©×™×¨×•×ª ×œ×˜×™×¤×•×œ×™× ×‘×¨×¤×•××” ××©×œ×™××”",
        "includes": ["××•×¡×˜××•×¤×ª×™×”", "×›×™×¨×•×¤×¨×§×˜×™×§×”", "×“×™×§×•×¨ ×¡×™× ×™", "×”×•×××•×¤×ª×™×”", "× ×˜×•×¨×•×¤×ª×™×”"],
        "reimbursement": {
            "×˜×™×¤×•×œ ×‘×•×“×“": "50-80 ×©\"×— ×œ×˜×™×¤×•×œ",
            "×©×™×¢×•×¨ ×”×—×–×¨": "×œ×¤×™ ×ª×¢×¨×™×¤×•×Ÿ"
        },
        "limits": {"×©× ×ª×™": "12-20 ×˜×™×¤×•×œ×™×", "×œ×˜×™×¤×•×œ": "×¢×“ 150 ×©\"×—"},
        "notes": "××•×’×‘×œ ×œ××¡×¤×¨ ×˜×™×¤×•×œ×™× ×‘×©× ×”"
    },
    "5404": {
        "name": "×”×©×ª×œ×•×ª ×•×˜×™×¤×•×œ×™× ××™×•×—×“×™× ×‘×—×•\"×œ",
        "description": "×›×™×¡×•×™ ×œ×”×©×ª×œ×•×ª ××™×‘×¨×™× ×•×˜×™×¤×•×œ×™× ××ª×§×“××™× ×‘×—×•\"×œ",
        "includes": ["×”×©×ª×œ×ª ××™×‘×¨×™×", "×˜×™×¤×•×œ×™× ××•× ×§×•×œ×•×’×™×™× ××ª×§×“××™×", "×”×•×¦××•×ª × ×¡×™×¢×”", "××©×¤×•×–"],
        "reimbursement": {
            "×”×©×ª×œ×”": "×”×—×–×¨ ××œ× ×¢×“ ×ª×§×¨×”",
            "×˜×™×¤×•×œ×™× ××ª×§×“××™×": "×¢×“ ×ª×§×¨×ª ×”×¤×•×œ×™×¡×”",
            "× ×¡×™×¢×”": "×”×—×–×¨ ××œ×"
        },
        "limits": {"×©× ×ª×™": "×¢×“ ××™×œ×™×•×Ÿ ×“×•×œ×¨", "×œ××™×¨×•×¢": "×œ×¤×™ ××™×©×•×¨"},
        "notes": "×“×•×¨×© ××™×©×•×¨ ×¨×¤×•××™ ××•×§×“×"
    },
    "6417": {
        "name": "×”×¨×—×‘×” ×œ×ª×¨×•×¤×•×ª ××§×¡×˜×¨×”",
        "description": "×›×™×¡×•×™ ×œ×ª×¨×•×¤×•×ª ×©××™× ×Ÿ ×‘×¡×œ ×”×‘×¨×™××•×ª ×”×××©×œ×ª×™",
        "includes": ["×ª×¨×•×¤×•×ª ××—×•×¥ ×œ×¡×œ", "×ª×¨×•×¤×•×ª ×‘×™×•×œ×•×’×™×•×ª", "×ª×¨×•×¤×•×ª ××ª×§×“××•×ª ×œ×¡×¨×˜×Ÿ"],
        "reimbursement": {
            "×ª×¨×•×¤×•×ª ××—×•×¥ ×œ×¡×œ": "80-100% ×”×—×–×¨",
            "×ª×¨×•×¤×•×ª ×‘×™×•×œ×•×’×™×•×ª": "×”×—×–×¨ ××œ×"
        },
        "limits": {"×©× ×ª×™": "50,000-100,000 ×©\"×—", "×œ×ª×¨×•×¤×”": "×œ×¤×™ ××—×™×¨×•×Ÿ"},
        "notes": "×¢× ××™×©×•×¨ ×¨×•×¤× ××•××—×”"
    },
    "5406": {
        "name": "×¡×œ ×”×–×”×‘ - ×ª×¨×•×¤×•×ª ×©×œ× ×‘×¡×œ",
        "description": "×›×™×¡×•×™ ××•×¨×—×‘ ×œ×ª×¨×•×¤×•×ª ×™×§×¨×•×ª ×©×œ× ×‘×¡×œ ×”×‘×¨×™××•×ª",
        "includes": ["×ª×¨×•×¤×•×ª ××•× ×§×•×œ×•×’×™×•×ª", "×ª×¨×•×¤×•×ª ×‘×™×•×œ×•×’×™×•×ª", "×ª×¨×•×¤×•×ª ×œ×˜×¨×©×ª × ×¤×•×¦×”", "×ª×¨×•×¤×•×ª × ×“×™×¨×•×ª"],
        "reimbursement": {
            "×ª×¨×•×¤×•×ª ××•× ×§×•×œ×•×’×™×•×ª": "100% ×”×—×–×¨",
            "×ª×¨×•×¤×•×ª ×‘×™×•×œ×•×’×™×•×ª": "100% ×”×—×–×¨",
            "×ª×¨×•×¤×•×ª × ×“×™×¨×•×ª": "×”×—×–×¨ ××œ×"
        },
        "limits": {"×©× ×ª×™": "×¢×“ 300,000 ×©\"×—", "×œ×ª×¨×•×¤×”": "×œ×œ× ××’×‘×œ×”"},
        "notes": "×¡×›×•× ×‘×™×˜×•×— ×©× ×ª×™ ××•×’×‘×œ"
    },
    "6784": {
        "name": "× ×™×ª×•×—×™× ×¢× × ×•×ª×Ÿ ×©×™×¨×•×ª ×©×‘×”×¡×›×",
        "description": "×›×™×¡×•×™ ×œ× ×™×ª×•×—×™×, ×™×™×¢×•×¦×™× ×•×˜×™×¤×•×œ×™× ××—×œ×™×¤×™ × ×™×ª×•×— ×‘×™×©×¨××œ",
        "includes": ["× ×™×ª×•×—×™× ××œ×§×˜×™×‘×™×™×", "×™×™×¢×•×¦×™× ××•××—×™×", "×˜×™×¤×•×œ×™× ××—×œ×™×¤×™ × ×™×ª×•×—", "×‘×“×™×§×•×ª ×˜×¨×•× × ×™×ª×•×—"],
        "reimbursement": {
            "× ×™×ª×•×—": "×”×—×–×¨ ××œ× ×“×¨×š ×¨×©×ª",
            "×™×™×¢×•×¥ ××•××—×”": "×”×—×–×¨ ××œ×",
            "×˜×™×¤×•×œ ××—×œ×™×£": "100% ×”×—×–×¨"
        },
        "limits": {"×©× ×ª×™": "×œ×œ× ×”×’×‘×œ×”", "×œ× ×™×ª×•×—": "×“×¨×š ×¨×©×ª ×‘×œ×‘×“"},
        "notes": "×“×¨×š ×¨×©×ª × ×•×ª× ×™ ×©×™×¨×•×ª ×©×œ ×”×—×‘×¨×”"
    },
    "6650": {
        "name": "×©×™×¨×•×ª×™× ×××‘×•×œ×˜×•×¨×™×™×",
        "description": "×›×™×¡×•×™ ×œ×˜×™×¤×•×œ×™× ×•×™×™×¢×•×¦×™× ×œ×œ× ××©×¤×•×–",
        "includes": ["×™×™×¢×•×¦×™× ×¨×¤×•××™×™×", "×‘×“×™×§×•×ª ××¢×‘×“×”", "×‘×“×™×§×•×ª ×”×“××™×™×”", "×˜×™×¤×•×œ×™× ×¤×¨×”-×¨×¤×•××™×™×"],
        "reimbursement": {
            "MRI": "×”×—×–×¨ ×©×œ 70-80%",
            "CT": "×”×—×–×¨ ×©×œ 70-80%",
            "×‘×“×™×§×•×ª ××¢×‘×“×”": "×”×—×–×¨ ×©×œ 80%",
            "×™×™×¢×•×¥ ××•××—×”": "×”×—×–×¨ ×©×œ 75-80%",
            "××•×œ×˜×¨×¡××•× ×“": "×”×—×–×¨ ×©×œ 80%"
        },
        "limits": {"×©× ×ª×™": "×¢×“ 10,000-15,000 ×©\"×—", "×œ×‘×“×™×§×”": "×¢×“ 1,500 ×©\"×—"},
        "notes": "×›×•×œ×œ ×‘×“×™×§×•×ª ×× ×™×¢×”"
    },
    "773755": {
        "name": "×§×¨×Ÿ ××•×¨ ×˜×•×¤ - ×¤×™×¦×•×™ ×œ××—×œ×•×ª ×§×©×•×ª",
        "description": "×ª×©×œ×•× ×—×“ ×¤×¢××™ ×‘××§×¨×” ×©×œ ××‘×—×•×Ÿ ××—×œ×” ×§×©×”",
        "includes": ["×¡×¨×˜×Ÿ", "××•×˜× ×©×¨×™×¨ ×”×œ×‘", "×©×‘×¥ ××•×—×™", "×›×©×œ ×›×œ×™×™×ª×™", "××—×œ×•×ª ×œ×‘"],
        "reimbursement": {
            "×ª×©×œ×•× ×—×“ ×¤×¢××™": "×¡×›×•× ×§×‘×•×¢ ××¨××©",
            "×¡×¨×˜×Ÿ": "×œ×¤×™ ×—×•××¨×ª ×”××—×œ×”",
            "××•×˜×": "×ª×©×œ×•× ××œ×"
        },
        "limits": {"×œ××™×¨×•×¢": "50,000-100,000 ×©\"×—", "×›×•×œ×œ": "×œ×¤×™ ×”×¤×•×œ×™×¡×”"},
        "notes": "×¡×›×•× ×¤×™×¦×•×™ ×§×‘×•×¢ ××¨××©"
    },
    "799712": {
        "name": "×™×™×¢×•×¥ ×•×‘×“×™×§×•×ª ×××‘×•×œ×˜×•×¨×™",
        "description": "×’×™×©×” ×œ×™×™×¢×•×¦×™× ×¨×¤×•××™×™× ×•×‘×“×™×§×•×ª ××‘×—× ×ª×™×•×ª",
        "includes": ["×™×™×¢×•×¦×™ ××•××—×™×", "×‘×“×™×§×•×ª CT/MRI", "×‘×“×™×§×•×ª ××¢×‘×“×” ××ª×§×“××•×ª", "××•×œ×˜×¨×¡××•× ×“"],
        "reimbursement": {
            "×™×™×¢×•×¥": "×”×—×–×¨ ×©×œ 75-100%",
            "MRI/CT": "×”×—×–×¨ ××œ× ××• 80%",
            "××¢×‘×“×”": "×”×—×–×¨ ×©×œ 80-90%"
        },
        "limits": {"×©× ×ª×™": "×œ×œ× ×”×’×‘×œ×” ×‘×“×¨×š ×›×œ×œ", "×œ×‘×“×™×§×”": "×œ×œ× ××’×‘×œ×”"},
        "notes": "×œ×œ× ×¦×•×¨×š ×‘××™×©×•×¨ ××¨××©"
    },
    "799716": {
        "name": "×˜×™×¤×•×œ×™× ×˜×•×¤ - ×¨×¤×•××” ××©×œ×™××”",
        "description": "×›×ª×‘ ×©×™×¨×•×ª ×œ×˜×™×¤×•×œ×™× ×‘×¨×¤×•××” ××œ×˜×¨× ×˜×™×‘×™×ª",
        "includes": ["×¤×™×–×™×•×ª×¨×¤×™×”", "×“×™×§×•×¨ ×¡×™× ×™", "××•×¡×˜××•×¤×ª×™×”", "×¢×™×¡×•×™ ×¨×¤×•××™"],
        "reimbursement": {
            "×˜×™×¤×•×œ": "50-100 ×©\"×— ×œ×˜×™×¤×•×œ",
            "×©×™×¢×•×¨ ×”×—×–×¨": "×œ×¤×™ ×ª×¢×¨×™×¤×•×Ÿ ×”×—×‘×¨×”"
        },
        "limits": {"×©× ×ª×™": "15-25 ×˜×™×¤×•×œ×™×", "×œ×˜×™×¤×•×œ": "×¢×“ 150 ×©\"×—"},
        "notes": "××•×’×‘×œ ×œ××¡×¤×¨ ×˜×™×¤×•×œ×™× ×©× ×ª×™"
    },
    "5420": {
        "name": "×›×™×¡×•×™ ×‘×¨×™××•×ª ×‘×¡×™×¡×™",
        "description": "×›×™×¡×•×™ ×‘×¡×™×¡×™ ×œ×©×™×¨×•×ª×™ ×‘×¨×™××•×ª",
        "includes": ["××©×¤×•×–×™×", "× ×™×ª×•×—×™×", "×‘×“×™×§×•×ª ×‘×¡×™×¡×™×•×ª"],
        "reimbursement": {
            "××©×¤×•×–": "×”×—×–×¨ ××œ×",
            "× ×™×ª×•×—": "×”×—×–×¨ ××œ×"
        },
        "limits": {"×©× ×ª×™": "×œ×œ× ×”×’×‘×œ×”", "×œ××™×¨×•×¢": "×œ×œ× ××’×‘×œ×”"},
        "notes": "×ª× ××™× ×›×œ×œ×™×™× ×œ×‘×¨×™××•×ª 2016"
    },
    "7401": {
        "name": "× ×™×ª×•×—×™× ×‘×™×©×¨××œ",
        "description": "×›×™×¡×•×™ ××œ× ×œ× ×™×ª×•×—×™× ×‘××¨×¥",
        "includes": ["× ×™×ª×•×—×™× ×¤×œ×¡×˜×™×™× ××©×—×–×¨×™×", "× ×™×ª×•×—×™× ××•×¨×ª×•×¤×“×™×™×", "× ×™×ª×•×—×™× ×›×œ×œ×™×™×"],
        "reimbursement": {
            "× ×™×ª×•×—": "×”×—×–×¨ ××œ× ×“×¨×š ×¨×©×ª",
            "×‘×“×™×§×•×ª ×˜×¨×•×": "×”×—×–×¨ ××œ×"
        },
        "limits": {"×©× ×ª×™": "×œ×œ× ×”×’×‘×œ×”", "×œ× ×™×ª×•×—": "×“×¨×š ×¨×©×ª"},
        "notes": "×“×¨×š ×¨×©×ª ×‘×ª×™ ×—×•×œ×™× ××•×¡×›××ª"
    },
    "5411": {
        "name": "×›×™×¡×•×™ ×©×™× ×™×™×",
        "description": "×˜×™×¤×•×œ×™ ×©×™× ×™×™× ××ª×§×“××™×",
        "includes": ["×©×ª×œ×™×", "×›×ª×¨×™× ×•×’×©×¨×™×", "×™×™×©×•×¨ ×©×™× ×™×™×", "×˜×™×¤×•×œ×™ ×©×•×¨×©"],
        "reimbursement": {
            "×©×ª×œ": "×”×—×–×¨ ×©×œ 50-70%",
            "×›×ª×¨": "×”×—×–×¨ ×©×œ 60-80%",
            "×™×™×©×•×¨": "×”×—×–×¨ ×—×œ×§×™"
        },
        "limits": {"×©× ×ª×™": "5,000-15,000 ×©\"×—", "×œ×˜×™×¤×•×œ": "×œ×¤×™ ×¡×•×’"},
        "notes": "×¢× ×ª×§×•×¤×ª ×”××ª× ×”"
    },
    "5413": {
        "name": "××©×¤×•×– ×›×œ×œ×™",
        "description": "×›×™×¡×•×™ ×”×•×¦××•×ª ××©×¤×•×– ×‘×‘×ª×™ ×—×•×œ×™×",
        "includes": ["××™×˜×” ×¤×¨×˜×™×ª", "×œ×™×•×•×™", "× ×™×ª×•×—×™× ×‘××”×œ×š ××©×¤×•×–"],
        "reimbursement": {
            "××©×¤×•×–": "×”×—×–×¨ ××œ×",
            "××™×˜×” ×¤×¨×˜×™×ª": "×ª×•×¡×¤×ª ××œ××”"
        },
        "limits": {"×©× ×ª×™": "×œ×œ× ×”×’×‘×œ×”", "×œ×™×•×": "×œ×œ× ××’×‘×œ×”"},
        "notes": "×œ×œ× ×”×’×‘×œ×ª ×™××™ ××©×¤×•×–"
    },
    "6800": {
        "name": "×¡×™×¢×•×“",
        "description": "×‘×™×˜×•×— ×œ×¦×•×¨×›×™ ×¡×™×¢×•×“ ××¨×•×š ×˜×•×•×—",
        "includes": ["××¢× ×§ ×—×“ ×¤×¢××™", "×§×¦×‘×” ×—×•×“×©×™×ª", "×©×™×¨×•×ª×™ ×¡×™×¢×•×“ ×‘×‘×™×ª"],
        "reimbursement": {
            "××¢× ×§": "50,000-150,000 ×©\"×—",
            "×§×¦×‘×” ×—×•×“×©×™×ª": "3,000-8,000 ×©\"×—"
        },
        "limits": {"×—×•×“×©×™": "×œ×¤×™ ×“×¨×’×ª ×¡×™×¢×•×“", "×—×“ ×¤×¢××™": "×œ×¤×™ ×”×¤×•×œ×™×¡×”"},
        "notes": "×”×—×œ ××’×™×œ ××¡×•×™×"
    },
    "5408": {
        "name": "×‘×™×˜×•×— × ×¡×™×¢×•×ª ×œ×—×•\"×œ",
        "description": "×›×™×¡×•×™ ×¨×¤×•××™ ×‘× ×¡×™×¢×•×ª ×œ×—×•\"×œ",
        "includes": ["×˜×™×¤×•×œ ×¨×¤×•××™ ×—×™×¨×•×", "××©×¤×•×–", "×¤×™× ×•×™ ×¨×¤×•××™", "×”×—×–×¨ ×”×•×¦××•×ª"],
        "reimbursement": {
            "×˜×™×¤×•×œ ×—×™×¨×•×": "×”×—×–×¨ ××œ×",
            "××©×¤×•×–": "×”×—×–×¨ ××œ×",
            "×¤×™× ×•×™": "×”×—×–×¨ ××œ×"
        },
        "limits": {"×œ× ×¡×™×¢×”": "×¢×“ 60 ×™××™×", "×©× ×ª×™": "××¡×¤×¨ × ×¡×™×¢×•×ª"},
        "notes": "××•×’×‘×œ ×œ××¡×¤×¨ ×™××™× ×‘×©× ×”"
    },
    "5415": {
        "name": "××•×‘×“×Ÿ ×›×•×©×¨ ×¢×‘×•×“×”",
        "description": "×§×¦×‘×” ×‘××§×¨×” ×©×œ ××•×‘×“×Ÿ ×™×›×•×œ×ª ×¢×‘×•×“×”",
        "includes": ["×§×¦×‘×” ×—×•×“×©×™×ª", "×©×™×§×•× ×ª×¢×¡×•×§×ª×™", "×”×›×©×¨×” ××§×¦×•×¢×™×ª"],
        "reimbursement": {
            "×§×¦×‘×”": "50-75% ××”×©×›×¨",
            "×ª×§×•×¤×ª ×ª×©×œ×•×": "×¢×“ ×’×™×œ ×¤×¨×™×©×”"
        },
        "limits": {"×—×•×“×©×™": "×¢×“ 20,000 ×©\"×—", "×ª×§×•×¤×”": "×¢×“ ×¤×¨×™×©×”"},
        "notes": "×œ××—×¨ ×ª×§×•×¤×ª ×”××ª× ×”"
    },
    
    # ===== NISPACHIM × ×•×¡×¤×™× - × ×™×ª×•×—×™× =====
    "5401": {
        "name": "× ×™×ª×•×—×™× - ×¤×¨×™××™×•×",
        "description": "×›×™×¡×•×™ ××•×¨×—×‘ ×œ× ×™×ª×•×—×™× ×¢× ×‘×—×™×¨×ª ×× ×ª×— ×—×•×¤×©×™×ª",
        "includes": ["×‘×—×™×¨×ª ×× ×ª×— ×—×•×¤×©×™×ª", "×‘×ª×™ ×—×•×œ×™× ×¤×¨×˜×™×™×", "× ×™×ª×•×—×™× ××ª×§×“××™×"],
        "reimbursement": {"× ×™×ª×•×—": "×”×—×–×¨ ××œ×", "×‘×“×™×§×•×ª": "×”×—×–×¨ ××œ×"},
        "limits": {"×©× ×ª×™": "×œ×œ× ×”×’×‘×œ×”", "×œ× ×™×ª×•×—": "×œ×œ× ××’×‘×œ×”"},
        "notes": "×¨××ª ×›×™×¡×•×™ ×”×’×‘×•×”×” ×‘×™×•×ª×¨"
    },
    "5402": {
        "name": "× ×™×ª×•×—×™× - ×¡×˜× ×“×¨×˜",
        "description": "×›×™×¡×•×™ ×¨×’×™×œ ×œ× ×™×ª×•×—×™× ×‘×¨×©×™××ª ×× ×ª×—×™× ××•×’×“×¨×ª",
        "includes": ["×¨×©×™××ª ×× ×ª×—×™× ×××•×©×¨×™×", "× ×™×ª×•×—×™× × ×¤×•×¦×™×", "××©×¤×•×–"],
        "reimbursement": {"× ×™×ª×•×—": "×”×—×–×¨ ×œ×¤×™ ×¨×©×™××”", "××©×¤×•×–": "×”×—×–×¨ ××œ×"},
        "limits": {"×©× ×ª×™": "×œ×¤×™ ××’×‘×œ×•×ª", "×œ× ×™×ª×•×—": "×‘×¨×©×™××”"},
        "notes": "×›×™×¡×•×™ ×‘×¡×™×¡×™ ×œ× ×™×ª×•×—×™×"
    },
    "5403": {
        "name": "× ×™×ª×•×—×™× - ×”×©×œ××” ×œ×©×‘\"×Ÿ",
        "description": "×”×©×œ××” ×œ×›×™×¡×•×™ × ×™×ª×•×—×™× ×©×œ ×§×•×¤×ª ×”×—×•×œ×™×",
        "includes": ["×”×©×œ××” ×œ×§×•×¤×”", "×”×¤×¨×© ×”×©×ª×ª×¤×•×ª", "×©×™×¨×•×ª×™× × ×•×¡×¤×™×"],
        "reimbursement": {"×”×¤×¨×©": "×”×—×–×¨ ×”×¤×¨×©", "×ª×•×¡×¤×•×ª": "×œ×¤×™ ×ª×¢×¨×™×£"},
        "limits": {"×©× ×ª×™": "5,000 ×©\"×—", "×œ× ×™×ª×•×—": "×œ×¤×™ ×”×¤×¨×©"},
        "notes": "××©×œ×™× ××ª ×”×‘×™×˜×•×— ×”××©×œ×™×"
    },
    "6785": {
        "name": "× ×™×ª×•×—×™× ×œ×œ× ×”×©×ª×ª×¤×•×ª ×¢×¦××™×ª",
        "description": "×›×™×¡×•×™ ×œ× ×™×ª×•×—×™× ×œ×œ× ×ª×©×œ×•× ×¢×¦××™",
        "includes": ["×œ×œ× ×”×©×ª×ª×¤×•×ª", "×›×œ ×”×•×¦××•×ª ×”× ×™×ª×•×—", "××©×¤×•×– ××œ×"],
        "reimbursement": {"× ×™×ª×•×—": "100% ×œ×œ× ×”×©×ª×ª×¤×•×ª", "××©×¤×•×–": "××œ×"},
        "limits": {"×©× ×ª×™": "×œ×œ× ×”×’×‘×œ×”", "×œ× ×™×ª×•×—": "××œ×"},
        "notes": "×œ×œ× ×ª×©×œ×•× ×¢×¦××™ ×›×œ×œ"
    },
    
    # ===== NISPACHIM - ×ª×¨×•×¤×•×ª =====
    "5405": {
        "name": "×ª×¨×•×¤×•×ª ××—×•×¥ ×œ×¡×œ",
        "description": "×›×™×¡×•×™ ×œ×ª×¨×•×¤×•×ª ×©××™× ×Ÿ ×‘×¡×œ ×”×‘×¨×™××•×ª",
        "includes": ["×ª×¨×•×¤×•×ª ×—×“×©×•×ª", "×ª×¨×•×¤×•×ª ×™×§×¨×•×ª", "×˜×™×¤×•×œ×™× ××ª×§×“××™×"],
        "reimbursement": {"×ª×¨×•×¤×•×ª": "80-90% ×”×—×–×¨", "×‘×™×•×œ×•×’×™×•×ª": "×”×—×–×¨ ××œ×"},
        "limits": {"×©× ×ª×™": "50,000 ×©\"×—", "×œ×ª×¨×•×¤×”": "×œ×¤×™ ××—×™×¨"},
        "notes": "×“×•×¨×© ××™×©×•×¨ ×¨×•×¤×"
    },
    "5407": {
        "name": "×ª×¨×•×¤×•×ª ×œ×¡×¨×˜×Ÿ",
        "description": "×›×™×¡×•×™ ××™×•×—×“ ×œ×ª×¨×•×¤×•×ª ××•× ×§×•×œ×•×’×™×•×ª",
        "includes": ["×ª×¨×•×¤×•×ª ××•× ×§×•×œ×•×’×™×•×ª", "×˜×™×¤×•×œ×™× ×‘×™×•×œ×•×’×™×™×", "×—×“×©× ×•×ª ×¨×¤×•××™×ª"],
        "reimbursement": {"××•× ×§×•×œ×•×’×™×”": "100% ×”×—×–×¨", "×‘×™×•×œ×•×’×™": "×”×—×–×¨ ××œ×"},
        "limits": {"×©× ×ª×™": "×œ×œ× ×”×’×‘×œ×”", "×œ×ª×¨×•×¤×”": "×œ×œ× ××’×‘×œ×”"},
        "notes": "×›×™×¡×•×™ ××œ× ×œ×¡×¨×˜×Ÿ"
    },
    "6418": {
        "name": "×‘×“×™×§×•×ª ×’× ×•××™×•×ª",
        "description": "×‘×“×™×§×•×ª ×”×ª×××ª ×ª×¨×•×¤×•×ª ××™×©×™×•×ª",
        "includes": ["×‘×“×™×§×•×ª DNA", "×”×ª×××ª ×ª×¨×•×¤×•×ª", "×¨×¤×•××” ××•×ª×××ª ××™×©×™×ª"],
        "reimbursement": {"×‘×“×™×§×”": "×”×—×–×¨ ×©×œ 80%", "×™×™×¢×•×¥": "×”×—×–×¨ ××œ×"},
        "limits": {"×©× ×ª×™": "2-3 ×‘×“×™×§×•×ª", "×œ×‘×“×™×§×”": "×¢×“ 5,000 ×©\"×—"},
        "notes": "×˜×›× ×•×œ×•×’×™×” ××ª×§×“××ª"
    },
    "6419": {
        "name": "×˜×™×¤×•×œ×™× ×‘×™×•×œ×•×’×™×™×",
        "description": "×ª×¨×•×¤×•×ª ×‘×™×•×œ×•×’×™×•×ª ××ª×§×“××•×ª",
        "includes": ["×ª×¨×•×¤×•×ª ×‘×™×•×œ×•×’×™×•×ª", "××™××•× ×•×ª×¨×¤×™×”", "×˜×™×¤×•×œ×™× ×—×“×©× ×™×™×"],
        "reimbursement": {"×‘×™×•×œ×•×’×™": "90-100% ×”×—×–×¨", "××™××•× ×•": "×”×—×–×¨ ××œ×"},
        "limits": {"×©× ×ª×™": "100,000 ×©\"×—", "×œ×ª×¨×•×¤×”": "×œ×¤×™ ×¦×•×¨×š"},
        "notes": "×ª×¨×•×¤×•×ª ××ª×§×“××•×ª"
    },
    
    # ===== NISPACHIM - ×××‘×•×œ×˜×•×¨×™ =====
    "6651": {
        "name": "×‘×“×™×§×•×ª ×”×“××™×” ××ª×§×“××•×ª",
        "description": "MRI, CT, PET-CT ×•×¢×•×“",
        "includes": ["MRI", "CT", "PET-CT", "××•×œ×˜×¨×¡××•× ×“ ×“×•×¤×œ×¨"],
        "reimbursement": {"MRI": "80% ×”×—×–×¨", "CT": "80% ×”×—×–×¨", "PET-CT": "×”×—×–×¨ ××œ×"},
        "limits": {"×©× ×ª×™": "×œ×œ× ×”×’×‘×œ×”", "×œ×‘×“×™×§×”": "×¢×“ 2,000 ×©\"×—"},
        "notes": "×‘×“×™×§×•×ª ×“×™××•×ª ××ª×§×“××•×ª"
    },
    "6652": {
        "name": "×™×™×¢×•×¦×™× ×œ××•××—×™×",
        "description": "×”×ª×™×™×¢×¦×•×™×•×ª ×¢× ×¨×•×¤××™× ××•××—×™×",
        "includes": ["××•××—×™× ×‘×›×™×¨×™×", "×—×•×•×ª ×“×¢×ª ×©× ×™×™×”", "×™×™×¢×•×¥ ××”×™×¨"],
        "reimbursement": {"×™×™×¢×•×¥": "75-85% ×”×—×–×¨", "×—×•×•×ª ×“×¢×ª": "×”×—×–×¨ ××œ×"},
        "limits": {"×©× ×ª×™": "10-15 ×™×™×¢×•×¦×™×", "×œ×™×™×¢×•×¥": "×¢×“ 600 ×©\"×—"},
        "notes": "×’×™×©×” ×œ××•××—×™× ××•×‘×™×œ×™×"
    },
    "6653": {
        "name": "×‘×“×™×§×•×ª ××¢×‘×“×”",
        "description": "×‘×“×™×§×•×ª ×“× ×•××¢×‘×“×” ××ª×§×“××•×ª",
        "includes": ["×‘×“×™×§×•×ª ×“× ××•×¨×›×‘×•×ª", "×‘×“×™×§×•×ª ×’× ×˜×™×•×ª", "×¡×× ×™× ×‘×™×•×œ×•×’×™×™×"],
        "reimbursement": {"×“×": "80% ×”×—×–×¨", "×’× ×˜×™": "×”×—×–×¨ ×©×œ 70%"},
        "limits": {"×©× ×ª×™": "5,000 ×©\"×—", "×œ×‘×“×™×§×”": "×œ×¤×™ ×¡×•×’"},
        "notes": "××¢×‘×“×•×ª ××ª×§×“××•×ª"
    },
    "8714": {
        "name": "×—×•×•×ª ×“×¢×ª ×¨×¤×•××™×ª ×©× ×™×™×”",
        "description": "×§×‘×œ×ª ×—×•×•×ª ×“×¢×ª × ×•×¡×¤×ª ××¨×•×¤× ××•××—×”",
        "includes": ["××•××—×” ×‘×›×™×¨", "×—×•×•×ª ×“×¢×ª ××¤×•×¨×˜×ª", "×™×™×¢×•×¥ ×˜×œ×¤×•× ×™"],
        "reimbursement": {"×—×•×•×ª ×“×¢×ª": "×”×—×–×¨ ××œ×", "×™×™×¢×•×¥": "×”×—×–×¨ ××œ×"},
        "limits": {"×©× ×ª×™": "2-3 ×—×•×•×ª ×“×¢×ª", "×œ×—×•×•×ª ×“×¢×ª": "×œ×œ× ××’×‘×œ×”"},
        "notes": "×—×©×•×‘ ×œ×§×‘×œ×ª ×”×—×œ×˜×•×ª"
    },
    
    # ===== NISPACHIM - ××—×œ×•×ª ×§×©×•×ª =====
    "5416": {
        "name": "×¤×™×¦×•×™ ×œ××—×œ×•×ª ×§×©×•×ª",
        "description": "×¤×™×¦×•×™ ×›×¡×¤×™ ×‘-32 ××—×œ×•×ª ×§×©×•×ª",
        "includes": ["×¡×¨×˜×Ÿ", "××•×˜×", "×©×‘×¥", "×›×©×œ ×›×œ×™×•×ª", "× ×™×•×•×Ÿ ×©×¨×™×¨×™×"],
        "reimbursement": {"×¤×™×¦×•×™": "×¡×›×•× ×—×“ ×¤×¢××™", "×¡×›×•×": "50,000-150,000 ×©\"×—"},
        "limits": {"××™×¨×•×¢": "×¤×¢× ××—×ª", "×¡×”\"×›": "×œ×¤×™ ×¤×•×œ×™×¡×”"},
        "notes": "32 ××—×œ×•×ª ××•×’×“×¨×•×ª"
    },
    "5417": {
        "name": "×¤×™×¦×•×™ ×œ×¡×¨×˜×Ÿ",
        "description": "×¤×™×¦×•×™ ×›×¡×¤×™ ×¡×¤×¦×™×¤×™ ×œ××—×œ×•×ª ×¡×¨×˜×Ÿ",
        "includes": ["×›×œ ×¡×•×’×™ ×”×¡×¨×˜×Ÿ", "×¤×™×¦×•×™ ×—×“ ×¤×¢××™", "×ª×©×œ×•× ××”×™×¨"],
        "reimbursement": {"×¡×¨×˜×Ÿ": "50,000-100,000 ×©\"×—", "××˜×¡×˜×–×•×ª": "×ª×•×¡×¤×ª"},
        "limits": {"××™×¨×•×¢": "×¤×¢× ××—×ª", "×¡×”\"×›": "×œ×¤×™ ×—×•××¨×”"},
        "notes": "×¤×™×¦×•×™ ××™×™×“×™"
    },
    "5418": {
        "name": "×¤×™×¦×•×™ ×œ××—×œ×•×ª ×œ×‘",
        "description": "×¤×™×¦×•×™ ×›×¡×¤×™ ×œ××—×œ×•×ª ×œ×‘ ×•×›×œ×™ ×“×",
        "includes": ["××•×˜×", "× ×™×ª×•×— ×œ×‘ ×¤×ª×•×—", "××™ ×¡×¤×™×§×ª ×œ×‘", "××—×œ×•×ª ××¡×ª××™×"],
        "reimbursement": {"××•×˜×": "70,000 ×©\"×—", "× ×™×ª×•×—": "50,000 ×©\"×—"},
        "limits": {"××™×¨×•×¢": "×¤×¢× ××—×ª", "×¡×”\"×›": "×œ×¤×™ ××§×¨×”"},
        "notes": "××—×œ×•×ª ×œ×‘ ××•×’×“×¨×•×ª"
    },
    "773756": {
        "name": "××—×œ×•×ª × ×“×™×¨×•×ª",
        "description": "×›×™×¡×•×™ ×œ××—×œ×•×ª × ×“×™×¨×•×ª ×•××•×¨×¤× ×™×•×ª",
        "includes": ["××—×œ×•×ª × ×“×™×¨×•×ª", "×˜×™×¤×•×œ×™× ×™×™×—×•×“×™×™×", "×ª×¨×•×¤×•×ª ××•×¨×¤× ×™×•×ª"],
        "reimbursement": {"×˜×™×¤×•×œ": "×”×—×–×¨ ××œ×", "×ª×¨×•×¤×•×ª": "100% ×”×—×–×¨"},
        "limits": {"×©× ×ª×™": "×œ×œ× ×”×’×‘×œ×”", "×œ×˜×™×¤×•×œ": "×œ×¤×™ ×¦×•×¨×š"},
        "notes": "×›×™×¡×•×™ ×™×™×—×•×“×™"
    },
    
    # ===== NISPACHIM - ×©×™× ×™×™× =====
    "5412": {
        "name": "×©×™× ×™×™× ××•×¨×—×‘",
        "description": "×˜×™×¤×•×œ×™ ×©×™× ×™×™× ×›×•×œ×œ ××•×¨×ª×•×“×•× ×˜×™×”",
        "includes": ["×©×ª×œ×™×", "×›×ª×¨×™×", "×™×™×©×•×¨", "×”×œ×‘× ×”", "××¡×ª×˜×™×§×”"],
        "reimbursement": {"×©×ª×œ": "60% ×”×—×–×¨", "×›×ª×¨": "70% ×”×—×–×¨", "×™×™×©×•×¨": "50% ×”×—×–×¨"},
        "limits": {"×©× ×ª×™": "15,000 ×©\"×—", "×œ×˜×™×¤×•×œ": "×œ×¤×™ ×¡×•×’"},
        "notes": "×›×™×¡×•×™ ××•×¨×—×‘"
    },
    "5414": {
        "name": "×©×™× ×™×™× - ×”×©×ª×œ×•×ª",
        "description": "×”×©×ª×œ×•×ª ×©×™× ×™×™× ×•×©×™×§×•× ×”×¤×”",
        "includes": ["×”×©×ª×œ×•×ª", "×¢×¦×", "×©×™×§×•× ××œ×", "××¡×ª×˜×™×§×”"],
        "reimbursement": {"×”×©×ª×œ×”": "3,000-5,000 ×©\"×— ×œ×©×Ÿ", "×¢×¦×": "×”×—×–×¨ ×—×œ×§×™"},
        "limits": {"×©× ×ª×™": "20,000 ×©\"×—", "×œ×©×ª×œ": "×¢×“ 5,000 ×©\"×—"},
        "notes": "××•××—×™× ××•×‘×™×œ×™×"
    },
    "6420": {
        "name": "×©×™× ×™×™× - ××¡×ª×˜×™×§×”",
        "description": "×˜×™×¤×•×œ×™× ××¡×ª×˜×™×™× ×‘×©×™× ×™×™×",
        "includes": ["×”×œ×‘× ×”", "×—×™×¤×•×™×™×", "×•× ×™×¨×™×", "×©×™×§×•× ××¡×ª×˜×™"],
        "reimbursement": {"×”×œ×‘× ×”": "500 ×©\"×—", "×•× ×™×¨×™×": "30% ×”×—×–×¨"},
        "limits": {"×©× ×ª×™": "5,000 ×©\"×—", "×œ×˜×™×¤×•×œ": "×œ×¤×™ ×¡×•×’"},
        "notes": "××¡×ª×˜×™×§×” ×“× ×˜×œ×™×ª"
    },
    
    # ===== NISPACHIM - ×˜×›× ×•×œ×•×’×™×•×ª ××ª×§×“××•×ª =====
    "6793": {
        "name": "×˜×›× ×•×œ×•×’×™×•×ª ×¨×¤×•××™×•×ª ××ª×§×“××•×ª",
        "description": "×¦×™×•×“ ×•××›×©×™×¨×™× ×¨×¤×•××™×™× ××ª×§×“××™×",
        "includes": ["××›×©×™×¨×™× ×¨×¤×•××™×™×", "×˜×›× ×•×œ×•×’×™×” ×—×“×©×”", "×¦×™×•×“ ××ª×§×“×"],
        "reimbursement": {"××›×©×™×¨": "80% ×”×—×–×¨", "×˜×›× ×•×œ×•×’×™×”": "×”×—×–×¨ ×œ×¤×™ ××—×™×¨"},
        "limits": {"×©× ×ª×™": "50,000 ×©\"×—", "×œ××›×©×™×¨": "×¢×“ 10,000 ×©\"×—"},
        "notes": "×—×“×©× ×•×ª ×¨×¤×•××™×ª"
    },
    "6794": {
        "name": "××‘×™×–×¨×™× ×¨×¤×•××™×™×",
        "description": "×›×™×¡×•×™ ×œ××‘×™×–×¨×™× ×•×¢×–×¨×™× ×¨×¤×•××™×™×",
        "includes": ["×§×‘×™×™×", "×›×™×¡× ×’×œ×’×œ×™×", "××–×¨×Ÿ ××•×¨×˜×•×¤×“×™", "×¢×–×¨×™×"],
        "reimbursement": {"××‘×™×–×¨": "70-80% ×”×—×–×¨", "×¢×–×¨": "×”×—×–×¨ ×œ×¤×™ ××—×™×¨"},
        "limits": {"×©× ×ª×™": "10,000 ×©\"×—", "×œ××‘×™×–×¨": "×¢×“ 5,000 ×©\"×—"},
        "notes": "××‘×™×–×¨×™× ×××•×©×¨×™×"
    },
    "6795": {
        "name": "×¨×•×‘×•×˜×™×§×” ×¨×¤×•××™×ª",
        "description": "× ×™×ª×•×—×™× ×¨×•×‘×•×˜×™×™× ××ª×§×“××™×",
        "includes": ["× ×™×ª×•×— ×¨×•×‘×•×˜×™", "×“×”-×•×™× ×¦'×™", "×˜×›× ×•×œ×•×’×™×” ××ª×§×“××ª"],
        "reimbursement": {"× ×™×ª×•×— ×¨×•×‘×•×˜×™": "×”×—×–×¨ ××œ×", "×ª×•×¡×¤×ª": "×œ×¤×™ ×¡×•×’"},
        "limits": {"×©× ×ª×™": "×œ×œ× ×”×’×‘×œ×”", "×œ× ×™×ª×•×—": "××œ×"},
        "notes": "×˜×›× ×•×œ×•×’×™×” ××ª×§×“××ª"
    },
    
    # ===== NISPACHIM - ×¤×•×¨×™×•×ª =====
    "6421": {
        "name": "×˜×™×¤×•×œ×™ ×¤×•×¨×™×•×ª",
        "description": "×”×¤×¨×™×•×ª ×—×•×¥ ×’×•×¤×™×•×ª (IVF) ×•×˜×™×¤×•×œ×™× × ×œ×•×•×™×",
        "includes": ["IVF", "ICSI", "×”×–×¨×¢×”", "×œ×™×•×•×™ ×”×•×¨××•× ×œ×™"],
        "reimbursement": {"××—×–×•×¨": "10,000-20,000 ×©\"×—", "×ª×¨×•×¤×•×ª": "×”×—×–×¨ ×—×œ×§×™"},
        "limits": {"×©× ×ª×™": "2-3 ××—×–×•×¨×™×", "×œ××—×–×•×¨": "×¢×“ 20,000 ×©\"×—"},
        "notes": "×˜×™×¤×•×œ×™ IVF"
    },
    "6422": {
        "name": "×”×¨×™×•×Ÿ ×•×”×™×¨×™×•×Ÿ",
        "description": "×›×™×¡×•×™ ××•×¨×—×‘ ×œ×”×¨×™×•×Ÿ ×•×œ×™×“×”",
        "includes": ["××¢×§×‘ ×”×¨×™×•×Ÿ", "×‘×“×™×§×•×ª ×’× ×˜×™×•×ª", "×œ×™×“×” ×¤×¨×˜×™×ª", "××©×¤×•×–"],
        "reimbursement": {"××¢×§×‘": "×”×—×–×¨ ××œ×", "×œ×™×“×”": "×ª×•×¡×¤×ª ×¤×¨×˜×™×ª"},
        "limits": {"×œ×”×¨×™×•×Ÿ": "20,000 ×©\"×—", "×œ×œ×™×“×”": "5,000 ×©\"×—"},
        "notes": "××¢×§×‘ ××§×™×£"
    },
    
    # ===== NISPACHIM - ×™×œ×“×™× =====
    "6423": {
        "name": "×©×™×¨×•×ª×™× ×œ×™×œ×“",
        "description": "×›×™×¡×•×™ ××™×•×—×“ ×œ×¦×¨×›×™ ×™×œ×“×™×",
        "includes": ["×¨×•×¤× ×™×œ×“×™×", "×—×™×¡×•× ×™×", "×˜×™×¤×•×œ×™× ××™×•×—×“×™×", "×œ×™×•×•×™ ×”×ª×¤×ª×—×•×ª×™"],
        "reimbursement": {"×¨×•×¤×": "×”×—×–×¨ ××œ×", "×—×™×¡×•×Ÿ": "×”×—×–×¨ ××œ×"},
        "limits": {"×©× ×ª×™": "5,000 ×©\"×—", "×œ×˜×™×¤×•×œ": "×œ×¤×™ ×¡×•×’"},
        "notes": "×¢×“ ×’×™×œ 18"
    },
    "6424": {
        "name": "×”×ª×¤×ª×—×•×ª ×™×œ×“×™×",
        "description": "×˜×™×¤×•×œ×™× ×”×ª×¤×ª×—×•×ª×™×™× ×œ×™×œ×“×™×",
        "includes": ["×§×œ×™× ××•×ª ×ª×§×©×•×¨×ª", "×¨×™×¤×•×™ ×‘×¢×™×¡×•×§", "×¤×™×–×™×•×ª×¨×¤×™×”", "×¤×¡×™×›×•×œ×•×’"],
        "reimbursement": {"×˜×™×¤×•×œ": "150-200 ×©\"×— ×œ×˜×™×¤×•×œ", "××§×¦×•×¢×™": "×”×—×–×¨ ×©×œ 70%"},
        "limits": {"×©× ×ª×™": "50 ×˜×™×¤×•×œ×™×", "×œ×˜×™×¤×•×œ": "×¢×“ 250 ×©\"×—"},
        "notes": "×œ×™×•×•×™ ×”×ª×¤×ª×—×•×ª×™"
    },
    "6425": {
        "name": "××•×˜×™×–× ×•×”×¤×¨×¢×•×ª ×”×ª×¤×ª×—×•×ª",
        "description": "×˜×™×¤×•×œ×™× ××™×•×—×“×™× ×œ××•×˜×™×–×",
        "includes": ["ABA", "×˜×™×¤×•×œ ×”×ª× ×”×’×•×ª×™", "×§×œ×™× ××•×ª", "×¨×™×¤×•×™ ×‘×¢×™×¡×•×§"],
        "reimbursement": {"ABA": "200 ×©\"×— ×œ×©×¢×”", "×˜×™×¤×•×œ": "×”×—×–×¨ ×©×œ 80%"},
        "limits": {"×©× ×ª×™": "100,000 ×©\"×—", "×œ×˜×™×¤×•×œ": "×œ×¤×™ ×¦×•×¨×š"},
        "notes": "×›×™×¡×•×™ ××™×•×—×“"
    },
    
    # ===== NISPACHIM - × ×¤×© =====
    "6426": {
        "name": "×‘×¨×™××•×ª ×”× ×¤×©",
        "description": "×˜×™×¤×•×œ×™× ×¤×¡×™×›×•×œ×•×’×™×™× ×•×¤×¡×™×›×™××˜×¨×™×™×",
        "includes": ["×¤×¡×™×›×•×œ×•×’", "×¤×¡×™×›×™××˜×¨", "×˜×™×¤×•×œ ×§×‘×•×¦×ª×™", "CBT"],
        "reimbursement": {"×¤×’×™×©×”": "200-300 ×©\"×—", "×¤×¡×™×›×™××˜×¨": "×”×—×–×¨ ×©×œ 70%"},
        "limits": {"×©× ×ª×™": "30-50 ×¤×’×™×©×•×ª", "×œ×¤×’×™×©×”": "×¢×“ 350 ×©\"×—"},
        "notes": "×‘×¨×™××•×ª × ×¤×©"
    },
    "6427": {
        "name": "×’××™×œ×” ××”×ª××›×¨×•×™×•×ª",
        "description": "×˜×™×¤×•×œ×™× ×‘×”×ª××›×¨×•×™×•×ª",
        "includes": ["×’××™×œ×” ××¡××™×", "××œ×›×•×”×•×œ", "×”×™××•×¨×™×", "×©×™×§×•×"],
        "reimbursement": {"××©×¤×•×–": "×”×—×–×¨ ××œ×", "×©×™×§×•×": "×”×—×–×¨ ×©×œ 80%"},
        "limits": {"×©× ×ª×™": "60 ×™××™×", "×œ×ª×•×›× ×™×ª": "×œ×¤×™ ××™×©×•×¨"},
        "notes": "×ª×•×›× ×™×•×ª ×’××™×œ×”"
    },
    
    # ===== NISPACHIM - ×¡×™×¢×•×“ ×•××•×’×‘×œ×•×™×•×ª =====
    "6801": {
        "name": "×¡×™×¢×•×“ ××•×¨×—×‘",
        "description": "×›×™×¡×•×™ ××•×¨×—×‘ ×œ×¦×¨×›×™× ×¡×™×¢×•×“×™×™×",
        "includes": ["×§×¦×‘×” ×—×•×“×©×™×ª", "×©×™×¨×•×ª×™ ×¡×™×¢×•×“", "×¢×–×¨×™×", "×”×ª×××•×ª"],
        "reimbursement": {"×§×¦×‘×”": "5,000-10,000 ×©\"×—/×—×•×“×©", "×¢×–×¨×™×": "×”×—×–×¨ ××œ×"},
        "limits": {"×—×•×“×©×™": "×œ×¤×™ ×“×¨×’×”", "×©× ×ª×™": "×œ×œ× ×”×’×‘×œ×”"},
        "notes": "×›×™×¡×•×™ ××§×™×£"
    },
    "6802": {
        "name": "×©×™×§×•× ×¨×¤×•××™",
        "description": "×˜×™×¤×•×œ×™ ×©×™×§×•× ×•×¤×™×–×™×•×ª×¨×¤×™×”",
        "includes": ["×¤×™×–×™×•×ª×¨×¤×™×”", "×¨×™×¤×•×™ ×‘×¢×™×¡×•×§", "×”×™×“×¨×•×ª×¨×¤×™×”", "×©×™×§×•×"],
        "reimbursement": {"×˜×™×¤×•×œ": "150-200 ×©\"×—", "×©×™×§×•×": "×”×—×–×¨ ×©×œ 80%"},
        "limits": {"×©× ×ª×™": "50-80 ×˜×™×¤×•×œ×™×", "×œ×˜×™×¤×•×œ": "×¢×“ 250 ×©\"×—"},
        "notes": "×©×™×§×•× ××§×™×£"
    },
    "6803": {
        "name": "×¢×–×¨×™× ×•× ×’×™×©×•×ª",
        "description": "×”×ª×××•×ª ×‘×™×ª ×•×¢×–×¨×™× ×œ× ×›×™×",
        "includes": ["×”×ª×××•×ª ×‘×™×ª", "××¢×œ×™×ª", "××“×¨×’×•×ª", "×©×™×¤×•×¢×™×", "××‘×™×–×¨×™×"],
        "reimbursement": {"×”×ª×××”": "50% ×”×—×–×¨", "×¢×–×¨×™×": "×”×—×–×¨ ×©×œ 70%"},
        "limits": {"×©× ×ª×™": "50,000 ×©\"×—", "×œ×”×ª×××”": "×¢×“ 30,000 ×©\"×—"},
        "notes": "× ×’×™×©×•×ª ×œ× ×›×™×"
    },
    
    # ===== NISPACHIM - ×—×™×¨×•× ×•×ª××•× ×•×ª =====
    "5419": {
        "name": "×ª××•× ×•×ª ××™×©×™×•×ª",
        "description": "×›×™×¡×•×™ ×œ×ª××•× ×•×ª ×•×¤×’×™×¢×•×ª ×’×•×£",
        "includes": ["× ×›×•×ª", "××•×•×ª", "××•×‘×“×Ÿ ××™×‘×¨×™×", "×©×™×§×•×"],
        "reimbursement": {"× ×›×•×ª": "×œ×¤×™ %", "××•×•×ª": "×¡×›×•× ×§×‘×•×¢"},
        "limits": {"×œ××™×¨×•×¢": "500,000 ×©\"×—", "×©× ×ª×™": "×œ×¤×™ ×¤×•×œ×™×¡×”"},
        "notes": "×‘×™×˜×•×— ×ª××•× ×•×ª"
    },
    "6428": {
        "name": "×—×“×¨ ××™×•×Ÿ ×¤×¨×˜×™",
        "description": "×’×™×©×” ×œ×—×“×¨ ××™×•×Ÿ ×¤×¨×˜×™",
        "includes": ["ER ×¤×¨×˜×™", "×œ×œ× ×”××ª× ×”", "×˜×™×¤×•×œ ××”×™×¨", "××•××—×™×"],
        "reimbursement": {"×‘×™×§×•×¨": "×”×—×–×¨ ××œ×", "×˜×™×¤×•×œ×™×": "×”×—×–×¨ ××œ×"},
        "limits": {"×©× ×ª×™": "×œ×œ× ×”×’×‘×œ×”", "×œ×‘×™×§×•×¨": "×œ×œ× ××’×‘×œ×”"},
        "notes": "×©×™×¨×•×ª VIP"
    },
    "6429": {
        "name": "××“\"× ×•×”×¦×œ×”",
        "description": "×©×™×¨×•×ª×™ ×—×™×¨×•× ×•×”×¡×¢×” ×¨×¤×•××™×ª",
        "includes": ["×××‘×•×œ× ×¡", "×”×¡×¢×” ×¨×¤×•××™×ª", "××“\"×", "×˜×™×¤×•×œ ×—×™×¨×•×"],
        "reimbursement": {"×”×¡×¢×”": "×”×—×–×¨ ××œ×", "×—×™×¨×•×": "×”×—×–×¨ ××œ×"},
        "limits": {"×©× ×ª×™": "×œ×œ× ×”×’×‘×œ×”", "×œ××™×¨×•×¢": "×œ×œ× ××’×‘×œ×”"},
        "notes": "×©×™×¨×•×ª×™ ×—×™×¨×•×"
    },
    
    # ===== NISPACHIM ×¡×¤×¦×™×¤×™×™× ×œ×—×‘×¨×•×ª =====
    "7402": {
        "name": "×”×¨××œ - ××“×™×§×œ ×¤×œ×•×¡",
        "description": "×—×‘×™×œ×ª ×©×™×¨×•×ª×™× ××•×¨×—×‘×ª ×©×œ ×”×¨××œ",
        "includes": ["×›×œ ×”×©×™×¨×•×ª×™×", "×›×™×¡×•×™ ××§×™×£", "×¨×©×ª ×¨×—×‘×”", "×©×™×¨×•×ª VIP"],
        "reimbursement": {"×›×™×¡×•×™": "××§×¡×™××œ×™", "×©×™×¨×•×ª×™×": "×¨×—×‘"},
        "limits": {"×©× ×ª×™": "×œ×¤×™ ×ª×•×›× ×™×ª", "×›×•×œ×œ": "××§×™×£"},
        "notes": "×ª×•×›× ×™×ª ×¤×¨×™××™×•×"
    },
    "7403": {
        "name": "××’×“×œ - ×§×©×ª ×–×”×‘",
        "description": "×ª×•×›× ×™×ª ×¤×¨×™××™×•× ×©×œ ××’×“×œ",
        "includes": ["×›×™×¡×•×™ ××•×¨×—×‘", "×©×™×¨×•×ª×™× × ×•×¡×¤×™×", "×™×™×¢×•×¥ ×¨×¤×•××™", "×’×™×©×” ××”×™×¨×”"],
        "reimbursement": {"×›×™×¡×•×™": "×’×‘×•×”", "×©×™×¨×•×ª×™×": "××§×™×£"},
        "limits": {"×©× ×ª×™": "×œ×¤×™ ×ª×•×›× ×™×ª", "×›×•×œ×œ": "×¨×—×‘"},
        "notes": "×¨××” ×’×‘×•×”×”"
    },
    "7404": {
        "name": "×›×œ×œ - ××“×™×›×œ×œ ×¤×¨×™××™×•×",
        "description": "×ª×•×›× ×™×ª ××•×¨×—×‘×ª ×©×œ ×›×œ×œ",
        "includes": ["×›×™×¡×•×™ ×¨×—×‘", "××•××—×™× ××•×‘×™×œ×™×", "×˜×›× ×•×œ×•×’×™×”", "×©×™×¨×•×ª"],
        "reimbursement": {"×›×™×¡×•×™": "××§×¡×™××œ×™", "×©×™×¨×•×ª×™×": "××§×™×£"},
        "limits": {"×©× ×ª×™": "×œ×¤×™ ×ª×•×›× ×™×ª", "×›×•×œ×œ": "× ×¨×—×‘"},
        "notes": "×ª×•×›× ×™×ª ×¢×œ×™×•× ×”"
    },
    "7405": {
        "name": "×›×œ×œ - TOP100",
        "description": "×’×™×©×” ××”×™×¨×” ×œ-100 ×¨×•×¤××™× ××•×‘×™×œ×™×",
        "includes": ["100 ×¨×•×¤××™× ××•×‘×™×œ×™×", "×ª×•×¨ ×ª×•×š 7 ×™××™×", "××•××—×™× ×‘×›×™×¨×™×"],
        "reimbursement": {"×™×™×¢×•×¥": "×”×—×–×¨ ××œ×", "×’×™×©×”": "××™×™×“×™×ª"},
        "limits": {"×©× ×ª×™": "×œ×œ× ×”×’×‘×œ×”", "×œ×™×™×¢×•×¥": "×œ×œ× ××’×‘×œ×”"},
        "notes": "×©×™×¨×•×ª ×™×™×—×•×“×™"
    },
    "7406": {
        "name": "×”×¤× ×™×§×¡ - ×ª×•×›× ×™×ª ××¨×¤×",
        "description": "×¤×™×¦×•×™ ×œ××—×œ×•×ª ×§×©×•×ª - ×”×¤× ×™×§×¡",
        "includes": ["32 ××—×œ×•×ª", "×¤×™×¦×•×™ ××”×™×¨", "×ª×©×œ×•× ×—×“ ×¤×¢××™", "×œ×™×•×•×™"],
        "reimbursement": {"×¤×™×¦×•×™": "100,000-200,000 ×©\"×—", "××™×™×“×™": "×›×Ÿ"},
        "limits": {"××™×¨×•×¢": "×¤×¢× ××—×ª", "×¡×”\"×›": "×œ×¤×™ ×¤×•×œ×™×¡×”"},
        "notes": "×”×¤× ×™×§×¡ ×‘×œ×¢×“×™"
    },
    "7407": {
        "name": "×× ×•×¨×” - ×‘×¨×™××•×ª ××•×©×œ××ª",
        "description": "×—×‘×™×œ×” ××§×™×¤×” ×©×œ ×× ×•×¨×” ××‘×˜×—×™×",
        "includes": ["×›×™×¡×•×™ ×›×•×œ×œ", "×©×™×¨×•×ª×™× × ×•×¡×¤×™×", "×¨×©×ª ×¨×—×‘×”", "××•××—×™×"],
        "reimbursement": {"×›×™×¡×•×™": "××§×¡×™××œ×™", "×©×™×¨×•×ª×™×": "××§×™×£"},
        "limits": {"×©× ×ª×™": "×œ×¤×™ ×ª×•×›× ×™×ª", "×›×•×œ×œ": "× ×¨×—×‘"},
        "notes": "×ª×•×›× ×™×ª ××•×©×œ××ª"
    },
}

# ============================================================================
# NISPACH HELPER FUNCTIONS - WITH WEB SEARCH CAPABILITY
# ============================================================================

def extract_nispach_numbers(text):
    """
    ×—×™×œ×•×¥ ××¡×¤×¨×™ × ×¡×¤×—×™× ××©××œ×”
    ××–×”×” ××¡×¤×¨×™× ×‘×¤×•×¨××˜×™× ×©×•× ×™×: "× ×¡×¤×— 8713", "8713", "× ×¡×¤×— ××¡×¤×¨ 5409"
    
    Args:
        text: ×”×˜×§×¡×˜ ×œ×—×™×¤×•×© ××¡×¤×¨×™ × ×¡×¤×—×™×
        
    Returns:
        list: ×¨×©×™××ª ××¡×¤×¨×™ × ×¡×¤×—×™× ×©× ××¦××•
    """
    numbers = []
    
    # ×“×¤×•×¡ 1: "× ×¡×¤×— 8713" ××• "× ×¡×¤×— ××¡×¤×¨ 8713"
    pattern1 = r'× ×¡×¤×—\s*(?:××¡×¤×¨\s*)?(\d{4,6})'
    matches1 = re.findall(pattern1, text)
    numbers.extend(matches1)
    
    # ×“×¤×•×¡ 2: ××¡×¤×¨×™× ×©×œ 4-6 ×¡×¤×¨×•×ª (×¡×‘×™×¨ ×©×”× × ×¡×¤×—×™×)
    pattern2 = r'\b(\d{4,6})\b'
    matches2 = re.findall(pattern2, text)
    
    # ×¡×™× ×•×Ÿ: ×¨×§ ××¡×¤×¨×™× ×©××ª×—×™×œ×™× ×‘-5, 6, 7, ××• 8 (×˜×•×•×— × ×¡×¤×—×™× ×××™×ª×™)
    for num in matches2:
        if num[0] in ['5', '6', '7', '8'] and num not in numbers:
            numbers.append(num)
    
    return list(set(numbers))  # ×”×¡×¨×ª ×›×¤×™×œ×•×™×•×ª


def search_nispach_online_v2(nispach_number, client):
    """
    ×—×™×¤×•×© × ×¡×¤×— ×‘××™× ×˜×¨× ×˜ ×‘×××¦×¢×•×ª Claude API ×¢× Web Search REAL
    
    Args:
        nispach_number: ××¡×¤×¨ ×”× ×¡×¤×— ×œ×—×™×¤×•×©
        client: Anthropic client instance
        
    Returns:
        dict: ××™×“×¢ ×¢×œ ×”× ×¡×¤×— ××• None ×× ×œ× × ××¦×
    """
    try:
        # Use Claude with web_search tool to find information
        response = client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=2000,
            tools=[{
                "name": "web_search",
                "description": "Search the web for information",
                "input_schema": {
                    "type": "object",
                    "properties": {
                        "query": {
                            "type": "string",
                            "description": "Search query"
                        }
                    },
                    "required": ["query"]
                }
            }],
            messages=[{
                "role": "user",
                "content": f"""×—×¤×© ×‘××™× ×˜×¨× ×˜ ××™×“×¢ ×¢×œ × ×¡×¤×— {nispach_number} ×‘×‘×™×˜×•×— ×‘×¨×™××•×ª ×‘×™×©×¨××œ.

×—×¤×© ×‘××ª×¨×™× ×©×œ:
- ×—×‘×¨×•×ª ×”×‘×™×˜×•×— (×”×¨××œ, ××’×“×œ, ×›×œ×œ, ×¤× ×™×§×¡, ×× ×•×¨×”)
- ×¨×©×•×ª ×©×•×§ ×”×”×•×Ÿ
- ××ª×¨×™ ×”×©×•×•××ª ××—×™×¨×™×

×× ×™ ×¦×¨×™×š ×œ×“×¢×ª:
1. ××” ×©× ×”× ×¡×¤×—?
2. ××” ×”×•× ××›×¡×”?
3. ××™×œ×• ×©×™×¨×•×ª×™× ×›×œ×•×œ×™×?

×ª×Ÿ ×œ×™ ×ª×©×•×‘×” ××¡×•×“×¨×ª ×‘×¤×•×¨××˜ ×”×–×”:

×©×: [×©× ×”× ×¡×¤×—]
×ª×™××•×¨: [×ª×™××•×¨ ×§×¦×¨]
×›×•×œ×œ: [×¨×©×™××” ×©×œ ×©×™×¨×•×ª×™×]

×× ×œ× ××¦××ª ××™×“×¢ ×›×œ×œ - ×××¨ "×œ× × ××¦× ××™×“×¢"."""
            }]
        )
        
        # Process the response
        answer_text = ""
        
        for block in response.content:
            if block.type == "text":
                answer_text += block.text
        
        # If we found information
        # Check for "not found" indicators
        not_found_phrases = ["×œ× × ××¦×", "×œ× ××¦××ª×™", "××¦×˜×¢×¨", "××™×Ÿ ××™×“×¢", "×œ× ×–××™×Ÿ", "sorry", "not found"]
        found_not_found = any(phrase in answer_text.lower() for phrase in not_found_phrases)
        
        if answer_text and not found_not_found and len(answer_text) > 50:
            # Try to parse the structured response
            lines = answer_text.split('\n')
            name = f"× ×¡×¤×— {nispach_number}"
            description = ""
            includes = []
            
            for line in lines:
                line = line.strip()
                if line.startswith("×©×:"):
                    name = line.replace("×©×:", "").strip()
                elif line.startswith("×ª×™××•×¨:"):
                    description = line.replace("×ª×™××•×¨:", "").strip()
                elif line.startswith("×›×•×œ×œ:"):
                    includes_text = line.replace("×›×•×œ×œ:", "").strip()
                    includes = [x.strip() for x in includes_text.split(',') if x.strip()]
            
            # If we couldn't parse, use the whole text as description
            if not description or len(description) < 20:
                description = answer_text[:500]
            
            # If description is still just "sorry" or similar, return None
            if len(description) < 30 or any(phrase in description.lower() for phrase in not_found_phrases):
                return None
            
            return {
                "name": name,
                "description": description,
                "includes": includes,
                "reimbursement": {},
                "limits": {},
                "notes": "â„¹ï¸ ××™×“×¢ ×–×” × ××¦× ×‘×××¦×¢×•×ª ×—×™×¤×•×© ×‘××™× ×˜×¨× ×˜ ×•×¢×©×•×™ ×œ×”×©×ª× ×•×ª. ××•××œ×¥ ×œ×××ª ×¢× ×—×‘×¨×ª ×”×‘×™×˜×•×—.",
                "found_online": True,
                "source": "web_search",
                "raw_search_result": answer_text
            }
        
        return None
        
    except Exception as e:
        import traceback
        st.warning(f"×©×’×™××” ×‘×—×™×¤×•×© ×‘××™× ×˜×¨× ×˜: {str(e)}")
        st.code(traceback.format_exc())
        return None


def get_nispach_info_with_search(nispach_number, use_online_search=True, anthropic_client=None):
    """
    ××—×–×™×¨ ××™×“×¢ ×¢×œ × ×¡×¤×— - ×§×•×“× ××”×××’×¨ ×”××§×•××™, ×•×× ×œ× ×§×™×™× - ××—×™×¤×•×© ××•× ×œ×™×™×Ÿ
    
    Args:
        nispach_number: ××¡×¤×¨ ×”× ×¡×¤×—
        use_online_search: ×”×× ×œ×—×¤×© ×‘××•× ×œ×™×™×Ÿ ×× ×œ× × ××¦× ××§×•××™×ª
        anthropic_client: Anthropic client for web search
        
    Returns:
        dict: ××™×“×¢ ×¢×œ ×”× ×¡×¤×—
    """
    # × ×™×§×•×™ ×”××¡×¤×¨ (×”×¡×¨×ª ×¨×•×•×—×™× ×•×›×•')
    nispach_number = str(nispach_number).strip()
    
    # × ×™×¡×™×•×Ÿ ×¨××©×•×Ÿ - ××”×××’×¨ ×”××§×•××™
    if nispach_number in NISPACH_INFO_EXPANDED:
        info = NISPACH_INFO_EXPANDED[nispach_number].copy()
        info['source'] = 'local_database'
        info['nispach_number'] = nispach_number
        return info
    
    # ×× ×œ× × ××¦× ×•××•×ª×¨ ×—×™×¤×•×© ××•× ×œ×™×™×Ÿ
    if use_online_search and anthropic_client:
        st.info(f"ğŸ” ××—×¤×© ××™×“×¢ ×¢×œ × ×¡×¤×— {nispach_number} ×‘××™× ×˜×¨× ×˜...")
        online_result = search_nispach_online_v2(nispach_number, anthropic_client)
        if online_result and online_result.get("found_online"):
            online_result['nispach_number'] = nispach_number
            return online_result
    
    # ×‘×¨×™×¨×ª ××—×“×œ - × ×¡×¤×— ×œ× ×™×“×•×¢
    return {
        "name": f"× ×¡×¤×— {nispach_number}",
        "description": "××™×“×¢ ×¢×œ × ×¡×¤×— ×–×” ××™× ×• ×–××™×Ÿ ×‘×××’×¨. ×× × ×¤× ×” ×œ×—×‘×¨×ª ×”×‘×™×˜×•×— ×œ×¤×¨×˜×™×.",
        "unknown": True,
        "source": "unknown",
        "nispach_number": nispach_number
    }


def format_nispach_response(nispach_info):
    """
    ×¤×•×¨××˜ ×™×¤×” ×œ×ª×©×•×‘×” ×¢×œ × ×¡×¤×—
    
    Args:
        nispach_info: ××™×“×¢ ×¢×œ ×”× ×¡×¤×—
        
    Returns:
        str: ×ª×©×•×‘×” ××¤×•×¨××˜×ª
    """
    response = f"### × ×¡×¤×— {nispach_info.get('nispach_number', '???')}\n\n"
    response += f"**×©×:** {nispach_info['name']}\n\n"
    response += f"**×ª×™××•×¨:** {nispach_info['description']}\n\n"
    
    if nispach_info.get('includes'):
        response += "**×›×•×œ×œ:**\n"
        for item in nispach_info['includes']:
            response += f"- {item}\n"
        response += "\n"
    
    if nispach_info.get('reimbursement'):
        response += "**ğŸ’° ×©×™×¢×•×¨×™ ×”×—×–×¨:**\n"
        for service, amount in nispach_info['reimbursement'].items():
            response += f"- {service}: {amount}\n"
        response += "\n"
    
    if nispach_info.get('limits'):
        response += "**ğŸ“Š ××’×‘×œ×•×ª:**\n"
        for limit_type, limit_value in nispach_info['limits'].items():
            response += f"- {limit_type}: {limit_value}\n"
        response += "\n"
    
    if nispach_info.get('notes'):
        response += f"**ğŸ’¡ ×”×¢×¨×•×ª:** {nispach_info['notes']}\n\n"
    
    if nispach_info.get('source') == 'web_search':
        response += "â„¹ï¸ *××™×“×¢ ×–×” × ××¦× ×‘×××¦×¢×•×ª ×—×™×¤×•×© ×‘××™× ×˜×¨× ×˜*\n"
    elif nispach_info.get('unknown'):
        response += "âš ï¸ *× ×¡×¤×— ×–×” ×œ× × ××¦× ×‘×××’×¨ ×•×‘×—×™×¤×•×© ××•× ×œ×™×™×Ÿ*\n"
    
    return response


def get_all_known_nispachim():
    """××—×–×™×¨ ×¨×©×™××” ×××•×™× ×ª ×©×œ ×›×œ ××¡×¤×¨×™ ×”× ×¡×¤×—×™× ×”×™×“×•×¢×™×"""
    return sorted(NISPACH_INFO_EXPANDED.keys(), key=lambda x: int(x))


def get_nispach_info(nispach_number):
    """Get information about a specific nispach - Legacy function for backward compatibility"""
    # Clean the nispach number (remove common separators)
    clean_number = nispach_number.replace("/", "").replace("-", "").replace(" ", "")
    
    # Try to find the nispach
    if clean_number in NISPACH_INFO_EXPANDED:
        return NISPACH_INFO_EXPANDED[clean_number]
    
    # Try to find partial match (e.g., "5420" in "5420/8713")
    for key in NISPACH_INFO_EXPANDED.keys():
        if key in clean_number or clean_number in key:
            return NISPACH_INFO_EXPANDED[key]
    
    return None

# ============================================================================
# REST OF THE CODE REMAINS THE SAME
# ============================================================================

def hash_password(password):
    """Hash password using SHA256"""
    return hashlib.sha256(password.encode()).hexdigest()

def extract_text_from_pdf(pdf_file_or_bytes):
    """Extract text from PDF with improved handling for different formats"""
    if not PDF_SUPPORT: 
        return "âŒ PDF support not available", 0
    
    try:
        text = ""
        page_count = 0
        
        # Handle both file objects and bytes
        if isinstance(pdf_file_or_bytes, bytes):
            import io
            pdf_file_or_bytes = io.BytesIO(pdf_file_or_bytes)
        
        with pdfplumber.open(pdf_file_or_bytes) as pdf:
            page_count = len(pdf.pages)
            
            for i, page in enumerate(pdf.pages):
                try:
                    # Try extracting text
                    page_text = page.extract_text()
                    
                    # If no text, try extracting tables
                    if not page_text or len(page_text.strip()) < 20:
                        tables = page.extract_tables()
                        if tables:
                            page_text = ""
                            for table in tables:
                                for row in table:
                                    if row:
                                        page_text += " | ".join([str(cell) if cell else "" for cell in row]) + "\n"
                    
                    if page_text:
                        text += f"=== ×¢××•×“ {i+1} ===\n{page_text}\n\n---PAGE_BREAK---\n\n"
                    else:
                        text += f"=== ×¢××•×“ {i+1} ===\n[×œ× × ××¦× ×˜×§×¡×˜ ×‘×¢××•×“ ×–×”]\n\n---PAGE_BREAK---\n\n"
                        
                except Exception as page_error:
                    text += f"=== ×¢××•×“ {i+1} ===\n[×©×’×™××” ×‘×—×™×œ×•×¥ ×¢××•×“: {str(page_error)}]\n\n---PAGE_BREAK---\n\n"
        
        # Check if we extracted meaningful content
        if len(text.strip()) < 100:
            return "âš ï¸ ×œ× ×”×¦×œ×—× ×• ×œ×—×œ×¥ ×˜×§×¡×˜ ××¡×¤×™×§ ××”-PDF. ×™×™×ª×›×Ÿ ×©×”×•× ××‘×•×¡×¡ ×ª××•× ×•×ª ××• ×‘×¤×•×¨××˜ ×œ× × ×ª××š.", page_count
        
        return text, page_count
        
    except Exception as e:
        return f"âŒ ×©×’×™××” ×‘×§×¨×™××ª PDF: {str(e)}", 0

def detect_company_v2(text):
    """Detect insurance company from PDF text with priority indicators - v2 with fnx4u fix"""
    
    # HARDCODED FIX: If text contains fnx4u, it's Phoenix - NO QUESTIONS ASKED
    if 'fnx4u' in text.lower():
        return "×”×¤× ×™×§×¡"
    
    text_lower = text.lower()
    
    # Get first 2000 characters (header area where logo/company name usually appears)
    header_text = text[:2000]
    header_lower = header_text.lower()
    
    # Get last 1000 characters (footer where company name often appears)
    footer_text = text[-1000:] if len(text) > 1000 else text
    
    # Count occurrences for better detection
    company_scores = {
        "×”×¤× ×™×§×¡": 0,
        "×›×œ×œ": 0,
        "×”×¨××œ": 0,
        "××’×“×œ": 0,
        "×× ×•×¨×”": 0,
        "××™×™×œ×•×Ÿ": 0
    }
    
    # Priority 0: HIGHEST - Check header AND footer for company name - 25 points
    # Normal text
    if '×”×¤× ×™×§×¡' in header_text or '×¤× ×™×§×¡' in header_text:
        company_scores["×”×¤× ×™×§×¡"] += 25
    if '×›×œ×œ' in header_text and '×›×œ×œ×™' not in header_text:
        company_scores["×›×œ×œ"] += 25
    if '×”×¨××œ' in header_text:
        company_scores["×”×¨××œ"] += 25
    if '××’×“×œ' in header_text:
        company_scores["××’×“×œ"] += 25
    if '×× ×•×¨×”' in header_text:
        company_scores["×× ×•×¨×”"] += 25
    if '××™×™×œ×•×Ÿ' in header_text:
        company_scores["××™×™×œ×•×Ÿ"] += 25
    
    # Reversed text (RTL rendering issue) - CHECK FOOTER
    if '×¡×§×™× ×¤×”' in footer_text:  # ×”×¤× ×™×§×¡ reversed
        company_scores["×”×¤× ×™×§×¡"] += 25
    if '×œ×œ×›' in footer_text and '×™×œ×›' not in footer_text:  # ×›×œ×œ reversed (but not ×›×œ×›×œ×™)
        company_scores["×›×œ×œ"] += 25
    if '×œ××¨×”' in footer_text:  # ×”×¨××œ reversed
        company_scores["×”×¨××œ"] += 25
    if '×œ×“×’×' in footer_text:  # ××’×“×œ reversed
        company_scores["××’×“×œ"] += 25
    if '×”×¨×•× ×' in footer_text:  # ×× ×•×¨×” reversed
        company_scores["×× ×•×¨×”"] += 25
    if '×Ÿ×•×œ×™×' in footer_text:  # ××™×™×œ×•×Ÿ reversed
        company_scores["××™×™×œ×•×Ÿ"] += 25
    
    # Priority 1: Check for company-specific websites and emails (most reliable) - 10 points
    if 'fnx.co.il' in text_lower or 'myinfo.fnx' in text_lower or 'phoenix' in text_lower or 'fnx4u' in text_lower:
        company_scores["×”×¤× ×™×§×¡"] += 10
    if 'clal.co.il' in text_lower or 'clalbit.co.il' in text_lower or 'bit.clal.co.il' in text_lower or '@clal-ins.co.il' in text_lower or 'clal-ins.co.il' in text_lower:
        company_scores["×›×œ×œ"] += 10
    if 'harel-group.co.il' in text_lower or 'hrl.co.il' in text_lower:
        company_scores["×”×¨××œ"] += 10
    if 'migdal.co.il' in text_lower:
        company_scores["××’×“×œ"] += 10
    if 'menoramivt.co.il' in text_lower:
        company_scores["×× ×•×¨×”"] += 10
    if 'ayalon-ins.co.il' in text_lower:
        company_scores["××™×™×œ×•×Ÿ"] += 10
    
    # Priority 2: Check for company phone numbers - 8 points
    if '3455*' in text or '*3455' in text or '03-7332222' in text or '03-7357988' in text:
        company_scores["×”×¤× ×™×§×¡"] += 8
    if '*2800' in text or '2800*' in text or '03-6376666' in text or '077-6383290' in text or '6136902' in text:
        company_scores["×›×œ×œ"] += 8
    if '*2407' in text or '2407*' in text:
        company_scores["×”×¨××œ"] += 8
    if '*2679' in text or '2679*' in text:
        company_scores["××’×“×œ"] += 8
    if '*2000' in text or '2000*' in text:
        company_scores["×× ×•×¨×”"] += 8
    if '*5620' in text or '5620*' in text:
        company_scores["××™×™×œ×•×Ÿ"] += 8
    
    # Priority 3: Count company name appearances - 3 points each (both normal and reversed)
    company_scores["×”×¤× ×™×§×¡"] += (text.count('×¤× ×™×§×¡') + text.count('×”×¤× ×™×§×¡') + text.count('×¡×§×™× ×¤×”') + text.count('×¡×§×™× ×¤')) * 3
    company_scores["×›×œ×œ"] += ((text.count('×›×œ×œ') - text.count('×›×œ×œ×™')) + text.count('×œ×œ×›')) * 3
    company_scores["×”×¨××œ"] += (text.count('×”×¨××œ') + text.count('×œ××¨×”')) * 3
    company_scores["××’×“×œ"] += (text.count('××’×“×œ') + text.count('×œ×“×’×')) * 3
    company_scores["×× ×•×¨×”"] += (text.count('×× ×•×¨×”') + text.count('×”×¨×•× ×')) * 3
    company_scores["××™×™×œ×•×Ÿ"] += (text.count('××™×™×œ×•×Ÿ') + text.count('×Ÿ×•×œ×™×')) * 3
    
    # Priority 4: Check for unique company identifiers - 5 points
    if '×›×œ×œ ×—×‘×¨×” ×œ×‘×™×˜×•×—' in text or '×›×œ×œ ×ª×›× ×™×ª ×”×’×¨×™××˜×¨×™×•×ª' in text:
        company_scores["×›×œ×œ"] += 5
    if '×”×¤× ×™×§×¡ ×—×‘×¨×” ×œ×‘×™×˜×•×—' in text or ('×—×‘×¨×” ×œ×‘×™×˜×•×— ×‘×¢"×' in text and '×”×¤× ×™×§×¡' in text):
        company_scores["×”×¤× ×™×§×¡"] += 5
    # Reversed versions
    if '×—×•×˜×™×‘×œ ×”×¨×‘×— ×¡×§×™× ×¤×”' in text or '××´×¢×‘ ×—×•×˜×™×‘×œ ×”×¨×‘×—' in text and '×¡×§×™× ×¤×”' in text:
        company_scores["×”×¤× ×™×§×¡"] += 5
    
    # Return company with highest score (minimum 3 to avoid false positives)
    max_score = max(company_scores.values())
    if max_score >= 3:
        return max(company_scores, key=company_scores.get)
    
    return None

def create_chunks(text, size=1500, overlap=300):
    words = text.split()
    chunks = []
    for i in range(0, len(words), size - overlap):
        chunk = " ".join(words[i:i + size])
        if len(chunk.strip()) > 100: chunks.append(chunk)
    return chunks

@st.cache_resource
def init_connections():
    # Initialize Supabase
    url = st.secrets.get("SUPABASE_URL") or os.getenv("SUPABASE_URL")
    key = st.secrets.get("SUPABASE_KEY") or os.getenv("SUPABASE_KEY")
    
    if not url or not key:
        st.error("âš ï¸ Supabase credentials not configured!")
        st.stop()
    
    db = SupabaseDatabase(url=url, key=key)
    
    # Initialize Claude
    api_key = st.secrets.get("ANTHROPIC_API_KEY") or os.getenv("ANTHROPIC_API_KEY", "").strip()
    claude = None
    if api_key:
        try:
            claude = Anthropic(api_key=api_key)
            st.sidebar.success("âœ… Claude API connected!")
        except Exception as e:
            st.error(f"âŒ Error initializing Claude: {str(e)}")
            st.sidebar.error(f"Claude API Error: {str(e)[:100]}")
    else:
        st.sidebar.warning("âš ï¸ ANTHROPIC_API_KEY not found in secrets")
    
    return db, claude

db, claude_client = init_connections()

# TEST: Verify Supabase connection
st.sidebar.write("ğŸ” Testing Supabase...")
st.sidebar.write(f"URL: {db.url[:30]}...")
st.sidebar.write(f"Key: {db.key[:20]}...")
try:
    test = db.client.table("users").select("id").limit(1).execute()
    st.sidebar.success("âœ… Supabase connected!")
except Exception as e:
    st.sidebar.error(f"âŒ Supabase error: {str(e)[:100]}")

# Show nispach count in sidebar
st.sidebar.info(f"ğŸ“š ×‘×××’×¨: {len(NISPACH_INFO_EXPANDED)} × ×¡×¤×—×™×")

# ============================================================================
# REST OF THE APP CODE CONTINUES UNCHANGED...
# (The LOGIN, MAIN APP, and all pages remain exactly the same)
# ============================================================================

# LOGIN / REGISTER PAGE
if not st.session_state.authenticated:
    st.title("ğŸ” ×”×©×•×•××ª ×¤×•×œ×™×¡×•×ª ×‘×™×˜×•×—")
    
    tab1, tab2, tab3 = st.tabs(["ğŸ”‘ ×›× ×™×¡×”", "âœ¨ ×”×¨×©××”", "ğŸ”“ ×©×›×—×ª×™ ×¡×™×¡××”"])
    
    with tab1:
        st.subheader("×›× ×™×¡×” ×œ××¢×¨×›×ª")
        with st.form("login_form"):
            username = st.text_input("×©× ××©×ª××©")
            password = st.text_input("×¡×™×¡××”", type="password")
            submit = st.form_submit_button("×”×ª×—×‘×¨", type="primary", use_container_width=True)
            
            if submit:
                if username and password:
                    user_data = db.verify_user(username, password)
                    if user_data:
                        st.session_state.authenticated = True
                        st.session_state.user_id = user_data["id"]
                        st.session_state.username = user_data["username"]
                        st.success(f"×©×œ×•× {user_data['username']}!")
                        st.rerun()
                    else:
                        st.error("×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×")
                else:
                    st.warning("× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª")
    
    with tab2:
        st.subheader("×”×¨×©××” ×œ××¢×¨×›×ª")
        with st.form("register_form"):
            new_username = st.text_input("×©× ××©×ª××© (×‘×× ×’×œ×™×ª)")
            new_email = st.text_input("××™××™×™×œ")
            new_password = st.text_input("×¡×™×¡××”", type="password")
            new_password_confirm = st.text_input("××™×©×•×¨ ×¡×™×¡××”", type="password")
            register = st.form_submit_button("×”×™×¨×©×", type="primary", use_container_width=True)
            
            if register:
                if not all([new_username, new_email, new_password, new_password_confirm]):
                    st.warning("× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª")
                elif new_password != new_password_confirm:
                    st.error("×”×¡×™×¡×××•×ª ×œ× ×ª×•×××•×ª")
                elif len(new_password) < 6:
                    st.error("×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×›×™×œ ×œ×¤×—×•×ª 6 ×ª×•×•×™×")
                else:
                    user_id, error = db.create_user(new_username, new_email, new_password)
                    if user_id:
                        st.success("× ×¨×©××ª ×‘×”×¦×œ×—×”! ×¢×‘×•×¨ ×œ×œ×©×•× ×™×ª '×›× ×™×¡×”'")
                    else:
                        st.error(error)
    
    with tab3:
        st.subheader("××™×¤×•×¡ ×¡×™×¡××”")
        
        # Initialize reset state
        if 'reset_step' not in st.session_state:
            st.session_state.reset_step = 1
        if 'reset_email' not in st.session_state:
            st.session_state.reset_email = None
        if 'reset_code_generated' not in st.session_state:
            st.session_state.reset_code_generated = None
        
        if st.session_state.reset_step == 1:
            st.write("×”×–×Ÿ ××ª ×›×ª×•×‘×ª ×”××™××™×™×œ ×©×œ×š ×œ×§×‘×œ×ª ×§×•×“ ××™×¤×•×¡")
            
            with st.form("reset_email_form"):
                reset_email = st.text_input("××™××™×™×œ")
                send_code = st.form_submit_button("×©×œ×— ×§×•×“", type="primary", use_container_width=True)
                
                if send_code:
                    if reset_email:
                        code, error = db.create_reset_code(reset_email)
                        if code:
                            st.session_state.reset_code_generated = code
                            st.session_state.reset_email = reset_email
                            st.session_state.reset_step = 2
                            st.success(f"âœ… ×§×•×“ × ×©×œ×—!")
                            st.info(f"ğŸ”¢ **×§×•×“ ×”××™×¤×•×¡ ×©×œ×š:** {code}")
                            st.caption("(×‘××¦×™××•×ª ×™×™×©×œ×— ×œ××™×™×œ - ×–×” ×¨×§ ×œ×“××•)")
                            st.rerun()
                        else:
                            st.error(error)
                    else:
                        st.warning("× × ×œ×”×–×™×Ÿ ××™××™×™×œ")
        
        elif st.session_state.reset_step == 2:
            st.write(f"×§×•×“ × ×©×œ×— ×œ: **{st.session_state.reset_email}**")
            st.info(f"ğŸ”¢ ×”×§×•×“ ×©×œ×š: **{st.session_state.reset_code_generated}**")
            
            with st.form("reset_password_form"):
                reset_code_input = st.text_input("×§×•×“ ××™×¤×•×¡ (6 ×¡×¤×¨×•×ª)")
                new_pass = st.text_input("×¡×™×¡××” ×—×“×©×”", type="password")
                new_pass_confirm = st.text_input("××™×©×•×¨ ×¡×™×¡××” ×—×“×©×”", type="password")
                reset_submit = st.form_submit_button("××¤×¡ ×¡×™×¡××”", type="primary", use_container_width=True)
                
                if reset_submit:
                    if not all([reset_code_input, new_pass, new_pass_confirm]):
                        st.warning("× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª")
                    elif new_pass != new_pass_confirm:
                        st.error("×”×¡×™×¡×××•×ª ×œ× ×ª×•×××•×ª")
                    elif len(new_pass) < 6:
                        st.error("×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×›×™×œ ×œ×¤×—×•×ª 6 ×ª×•×•×™×")
                    else:
                        valid, user_id = db.verify_reset_code(st.session_state.reset_email, reset_code_input)
                        if valid:
                            db.reset_password(user_id, new_pass, reset_code_input)
                            st.success("âœ… ×”×¡×™×¡××” ××•×¤×¡×” ×‘×”×¦×œ×—×”!")
                            st.info("×¢×‘×•×¨ ×œ×œ×©×•× ×™×ª '×›× ×™×¡×”' ×›×“×™ ×œ×”×ª×—×‘×¨")
                            st.session_state.reset_step = 1
                            st.session_state.reset_email = None
                            st.session_state.reset_code_generated = None
                        else:
                            st.error(user_id)
            
            if st.button("×‘×™×˜×•×œ", use_container_width=True):
                st.session_state.reset_step = 1
                st.session_state.reset_email = None
                st.session_state.reset_code_generated = None
                st.rerun()
    
    st.stop()

# MAIN APP (AUTHENTICATED USERS ONLY)

# SIDEBAR
with st.sidebar:
    st.title("ğŸ” ×—×§×™×¨×•×ª")
    
    st.info(f"ğŸ‘¤ {st.session_state.username}")
    if st.button("ğŸšª ×”×ª× ×ª×§", use_container_width=True):
        st.session_state.authenticated = False
        st.session_state.user_id = None
        st.session_state.username = None
        st.session_state.current_investigation_id = None
        st.rerun()
    
    st.markdown("---")
    
    if st.session_state.current_investigation_id:
        inv = db.get_investigation(st.session_state.current_investigation_id)
        if inv:
            st.success(f"**{inv['client_name']}**")
            col1, col2 = st.columns(2)
            with col1:
                if st.button("âŒ ×¡×’×•×¨", use_container_width=True):
                    st.session_state.current_investigation_id = None
                    st.rerun()
            with col2:
                if st.button("ğŸ—‘ï¸ ××—×§", use_container_width=True):
                    try:
                        policies = db.get_policies(st.session_state.current_investigation_id)
                        for pol in policies:
                            if pol.get('file_path') and os.path.exists(pol['file_path']):
                                os.remove(pol['file_path'])
                    except Exception as e:
                        pass
                    
                    db.delete_investigation(st.session_state.current_investigation_id)
                    st.session_state.current_investigation_id = None
                    st.rerun()
    
    st.markdown("---")
    
    with st.expander("â• ×—×“×©", expanded=not st.session_state.current_investigation_id):
        client_name = st.text_input("×œ×§×•×—")
        if st.button("×¦×•×¨", type="primary", use_container_width=True):
            if client_name:
                try:
                    inv_id = db.create_investigation(st.session_state.user_id, client_name, "")
                    if inv_id:
                        st.session_state.current_investigation_id = inv_id
                        st.success(f"âœ… × ×•×¦×¨!")
                        st.rerun()
                    else:
                        st.error("âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×—×§×™×¨×”")
                except Exception as e:
                    st.error(f"âŒ ×©×’×™××”: {str(e)}")
            else:
                st.warning("âš ï¸ ××™×Ÿ ×©× ×œ×§×•×—")
    
    st.markdown("---")
    investigations = db.get_all_investigations(st.session_state.user_id)
    
    if investigations:
        st.caption(f"×”×—×§×™×¨×•×ª ×©×œ×™ ({len(investigations)})")
        for inv in investigations:
            if st.button(f"ğŸŸ¢ {inv['client_name']}", key=f"inv_{inv['id']}", use_container_width=True):
                st.session_state.current_investigation_id = inv['id']
                st.rerun()
    else:
        st.info("××™×Ÿ ×—×§×™×¨×•×ª. ×¦×•×¨ ×—×§×™×¨×” ×—×“×©×”!")

st.sidebar.markdown("---")

pages = ["ğŸ  ×‘×™×ª", "ğŸ“¥ ××™×š ×œ×”×©×™×’ ×¤×•×œ×™×¡×•×ª", "ğŸ“¤ ×”×¢×œ××”", "â“ ×©××œ×•×ª", "ğŸ“š ××“×¨×™×š × ×¡×¤×—×™×", "âš–ï¸ ×”×©×•×•××”", "ğŸ“œ ×”×™×¡×˜×•×¨×™×”"]
if st.session_state.username == "admin":
    pages.append("ğŸ‘‘ × ×™×”×•×œ")

for page in pages:
    if st.sidebar.button(page, use_container_width=True, key=f"nav_{page}"):
        st.session_state.page = page

# MAIN CONTENT
if not st.session_state.current_investigation_id and st.session_state.page not in ["ğŸ  ×‘×™×ª", "ğŸ“¥ ××™×š ×œ×”×©×™×’ ×¤×•×œ×™×¡×•×ª", "ğŸ“š ××“×¨×™×š × ×¡×¤×—×™×", "ğŸ‘‘ × ×™×”×•×œ"]:
    st.warning("âš ï¸ ×‘×—×¨ ×—×§×™×¨×”")
    st.stop()

if st.session_state.page == "ğŸ  ×‘×™×ª":
    st.title("ğŸ  ×”×©×•×•××ª ×¤×•×œ×™×¡×•×ª")
    st.write(f"×©×œ×•× **{st.session_state.username}**! ğŸ‘‹")
    
    all_inv = db.get_all_investigations(st.session_state.user_id)
    col1, col2 = st.columns(2)
    with col1: st.metric("×”×—×§×™×¨×•×ª ×©×œ×™", len(all_inv))
    with col2: st.metric("×¤×•×œ×™×¡×•×ª", sum(inv['policy_count'] for inv in all_inv))
    
    if all_inv:
        st.markdown("### ğŸ“Š ×”×—×§×™×¨×•×ª ×”××—×¨×•× ×•×ª")
        for inv in all_inv[:5]:
            with st.expander(f"ğŸ” {inv['client_name']}"):
                st.write(f"**×¤×•×œ×™×¡×•×ª:** {inv['policy_count']}")
                st.write(f"**×©××œ×•×ª:** {inv['question_count']}")
                st.caption(f"× ×•×¦×¨: {inv['created_at']}")

elif st.session_state.page == "ğŸ“¥ ××™×š ×œ×”×©×™×’ ×¤×•×œ×™×¡×•×ª":
    st.title("ğŸ“¥ ××™×š ×œ×”×©×™×’ ××ª ×”×¤×•×œ×™×¡×•×ª ×©×œ×š")
    st.write("××“×¨×™×š ×¤×©×•×˜ ×œ×§×‘×œ×ª ×¤×•×œ×™×¡×•×ª ××›×œ ×—×‘×¨×•×ª ×”×‘×™×˜×•×—")
    
    st.markdown("---")
    
    st.info("ğŸ’¡ **×˜×™×¤:** ×¨×•×‘ ×—×‘×¨×•×ª ×”×‘×™×˜×•×— ×××¤×©×¨×•×ª ×œ×”×•×¨×™×“ ××ª ×”×¤×•×œ×™×¡×•×ª ×©×œ×š ×“×¨×š ×”××–×•×¨ ×”××™×©×™ ×‘××ª×¨")
    
    st.markdown("---")
    
    # Company-specific instructions (keeping original code)
    with st.expander("ğŸ¢ ××’×“×œ - Migdal"):
        st.markdown("""
        ### ×©×œ×‘×™× ×œ×§×‘×œ×ª ×”×¤×•×œ×™×¡×”:
        
        1. **×›× ×¡ ×œ××ª×¨:** [www.migdal.co.il](https://www.migdal.co.il)
        2. **×”×ª×—×‘×¨ ×œ××–×•×¨ ×”××™×©×™** (×œ××¢×œ×” ×‘×¦×“ ×™××™×Ÿ)
        3. **×œ×—×¥ ×¢×œ "×”×¤×•×œ×™×¡×•×ª ×©×œ×™"**
        4. **×‘×—×¨ ××ª ×”×¤×•×œ×™×¡×”** ×©×¨×•×¦×” ×œ×”×•×¨×™×“
        5. **×œ×—×¥ ×¢×œ "×”×•×¨×“ ×¤×•×œ×™×¡×”"** ××• "PDF"
        
        ğŸ“ **××•×§×“ ×©×™×¨×•×ª:** *2679
        ğŸ“§ **××™××™×™×œ:** info@migdal.co.il
        """)
    
    with st.expander("ğŸ¢ ×”×¨××œ - Harel"):
        st.markdown("""
        ### ×©×œ×‘×™× ×œ×§×‘×œ×ª ×”×¤×•×œ×™×¡×”:
        
        1. **×›× ×¡ ×œ××ª×¨:** [www.harel-group.co.il](https://www.harel-group.co.il)
        2. **×”×ª×—×‘×¨ ×œ××–×•×¨ ×”××™×©×™**
        3. **×œ×—×¥ ×¢×œ "×”×¤×•×œ×™×¡×•×ª ×©×œ×™"**
        4. **×‘×—×¨ "×‘×™×˜×•×— ×‘×¨×™××•×ª" / "×—×™×¡×›×•×Ÿ" / "×¤× ×¡×™×”"** (×œ×¤×™ ×¡×•×’ ×”×¤×•×œ×™×¡×”)
        5. **×”×•×¨×“ PDF ×©×œ ×”×¤×•×œ×™×¡×”**
        
        ğŸ“ **××•×§×“ ×©×™×¨×•×ª:** *2407
        ğŸ“§ **××™××™×™×œ:** service@harel-group.co.il
        """)
    
    # (Rest of companies - same as original...)

elif st.session_state.page == "ğŸ“¤ ×”×¢×œ××”":
    st.title("ğŸ“¤ ×”×¢×œ××”")
    
    inv = db.get_investigation(st.session_state.current_investigation_id)
    st.info(f"ğŸ“ ×œ×§×•×—: **{inv['client_name']}**")
    
    uploaded_file = st.file_uploader("PDF", type=['pdf'])
    
    if uploaded_file:
        with st.spinner("××¢×‘×“..."):
            try:
                file_bytes = uploaded_file.getvalue()
                text, total_pages = extract_text_from_pdf(file_bytes)
                
                if not text or text.startswith("âŒ") or text.startswith("âš ï¸"):
                    st.error(text if text else "×œ× ×”×¦×œ×—× ×• ×œ×§×¨×•× ××ª ×”×§×•×‘×¥")
                else:
                    detected_company = detect_company_v2(text)
                    
                    if detected_company:
                        count = db.get_company_count(st.session_state.current_investigation_id, detected_company)
                        auto_name = detected_company if count == 0 else f"{detected_company} {count + 1}"
                    else:
                        auto_name = uploaded_file.name.replace('.pdf', '').replace('-', ' ')
                    
                    st.success(f"âœ… ×–×•×”×ª×” ×—×‘×¨×”: **{detected_company or '×œ× ×–×•×”×”'}**")
                    st.info(f"ğŸ“„ {total_pages} ×¢××•×“×™× | {len(text)} ×ª×•×•×™×")
                    
                    with st.form("form"):
                        company = st.selectbox("×—×‘×¨×”", COMPANIES, 
                                              index=COMPANIES.index(detected_company) if detected_company in COMPANIES else 0)
                        custom_name = st.text_input("×©× ×”×¤×•×œ×™×¡×”", value=auto_name)
                        
                        if st.form_submit_button("ğŸ’¾ ×©××•×¨", type="primary"):
                            safe_filename = f"{company}_{uuid.uuid4().hex[:8]}.pdf"
                            file_path = os.path.join(UPLOAD_DIR, safe_filename)
                            
                            with open(file_path, 'wb') as f:
                                f.write(file_bytes)
                            
                            chunks = create_chunks(text)
                            
                            policy_id = db.insert_policy(
                                st.session_state.current_investigation_id,
                                company,
                                uploaded_file.name,
                                custom_name,
                                file_path,
                                total_pages
                            )
                            db.insert_chunks(policy_id, chunks)
                            
                            st.success(f"âœ… × ×©××¨: **{custom_name}**")
                            st.balloons()
                            st.rerun()
            
            except Exception as e:
                st.error(f"âŒ ×©×’×™××”: {str(e)}")
    
    st.markdown("---")
    
    policies = db.get_policies(st.session_state.current_investigation_id)
    
    if policies:
        st.markdown(f"### ğŸ“„ ×¤×•×œ×™×¡×•×ª ×©×œ {inv['client_name']}")
        st.caption(f"×¡×”×´×›: {len(policies)} ×¤×•×œ×™×¡×•×ª")
        
        for pol in policies:
            with st.expander(f"ğŸ“„ {pol['custom_name']}"):
                col1, col2 = st.columns([4, 1])
                with col1:
                    st.write(f"**×—×‘×¨×”:** {pol['company']}")
                    st.write(f"**×¢××•×“×™×:** {pol['total_pages']}")
                with col2:
                    if st.button("ğŸ—‘ï¸ ××—×§", key=f"del_{pol['id']}"):
                        try:
                            if pol.get('file_path') and os.path.exists(pol['file_path']):
                                os.remove(pol['file_path'])
                        except:
                            pass
                        
                        db.delete_policy(pol['id'])
                        st.success("× ××—×§!")
                        st.rerun()

elif st.session_state.page == "â“ ×©××œ×•×ª":
    st.title("â“ ×©××œ×•×ª")
    
    mode = st.radio(
        "×‘×—×¨ ×¡×•×’ ×©××œ×”:",
        ["ğŸ“„ ×©××œ ×¢×œ ×”×¤×•×œ×™×¡×•×ª ×©×œ×™", "ğŸŒ ××™×“×¢ ×›×œ×œ×™ ×¢×œ ×‘×™×˜×•×—×™×"],
        horizontal=True
    )
    
    if mode == "ğŸ“„ ×©××œ ×¢×œ ×”×¤×•×œ×™×¡×•×ª ×©×œ×™":
        policies = db.get_policies(st.session_state.current_investigation_id)
        
        if not policies:
            st.warning("âš ï¸ ×”×¢×œ×” ×¤×•×œ×™×¡×•×ª")
        else:
            policy_options = {pol['custom_name']: pol['id'] for pol in policies}
            selected_names = st.multiselect("×‘×—×¨ ×¤×•×œ×™×¡×•×ª:", list(policy_options.keys()), 
                                           default=list(policy_options.keys()))
            
            if selected_names:
                query = st.text_area("×©××œ ×©××œ×”:", 
                                    placeholder="×œ××©×œ: ××” ×”××—×™×¨ ×”×—×•×“×©×™ ×œ×’×™×œ 30?",
                                    height=100)
                
                if st.button("ğŸ” ×©××œ", type="primary") and query:
                    api_key = st.secrets.get("ANTHROPIC_API_KEY") or os.getenv("ANTHROPIC_API_KEY", "").strip()
                    if not api_key:
                        st.error("âŒ API key not configured")
                    else:
                        try:
                            fresh_claude = Anthropic(api_key=api_key)
                        except Exception as e:
                            st.error(f"âŒ Failed to initialize Claude: {str(e)}")
                            fresh_claude = None
                        
                        if fresh_claude:
                            with st.spinner("××—×¤×© ×•×× ×ª×—..."):
                                try:
                                    # Check for nispach numbers using new function
                                    nispach_numbers = extract_nispach_numbers(query)
                                    
                                    if nispach_numbers:
                                        st.info(f"ğŸ” ×–×™×”×™×ª×™ ×©××œ×” ×¢×œ × ×¡×¤×—×™×: {', '.join(nispach_numbers)}")
                                        
                                        for num in nispach_numbers:
                                            nispach_info = get_nispach_info_with_search(
                                                nispach_number=num,
                                                use_online_search=True,
                                                anthropic_client=fresh_claude
                                            )
                                            
                                            formatted_response = format_nispach_response(nispach_info)
                                            st.markdown(formatted_response)
                                    
                                    # Continue with normal PDF search...
                                    selected_ids = [policy_options[name] for name in selected_names]
                                    all_contexts = []
                                    
                                    for name, pol_id in zip(selected_names, selected_ids):
                                        chunks = db.search_chunks(pol_id, query, top_k=20)
                                        if chunks:
                                            context = f"=== ×¤×•×œ×™×¡×”: {name} ===\n" + "\n\n".join([c['text'] for c in chunks[:8]])
                                            all_contexts.append(context)
                                    
                                    if all_contexts:
                                        combined = "\n\n".join(all_contexts)
                                        
                                        system_prompt = """××ª×” ××•××—×” ×‘×™×˜×•×— ×™×©×¨××œ×™. ×—×œ×¥ ××™×“×¢ ××“×•×™×§ ××¤×•×œ×™×¡×•×ª.

×›×œ×œ×™×:
1. ×—×¤×© ×˜×‘×œ××•×ª ××—×™×¨×™× ×•×”×¦×’ ××•×ª×Ÿ ×‘××“×•×™×§
2. ××œ ×ª××¦×™× ××™×“×¢
3. ×¢× ×” ×‘×¢×‘×¨×™×ª ×¤×©×•×˜×” ×•×‘×¨×•×¨×”
4. ×”×©×•×•×” ×‘×™×Ÿ ×¤×•×œ×™×¡×•×ª ×× ×™×© ×™×•×ª×¨ ×××—×ª"""
                                        
                                        user_content = f"""×©××œ×”: {query}

×ª×•×›×Ÿ ××”×¤×•×œ×™×¡×•×ª:
{combined}

×¢× ×” ×‘×“×™×•×§ ×¢×œ ×¡××š ×”××™×“×¢."""
                                        
                                        response = fresh_claude.messages.create(
                                            model="claude-sonnet-4-20250514",
                                            max_tokens=1800,
                                            system=system_prompt,
                                            messages=[{"role": "user", "content": user_content}]
                                        )
                                        
                                        answer = response.content[0].text
                                        st.markdown("### ğŸ’¡ ×ª×©×•×‘×”:")
                                        st.success(answer)
                                        
                                        db.save_qa(st.session_state.current_investigation_id, query, answer, selected_names)
                                    else:
                                        st.warning("âŒ ×œ× × ××¦× ××™×“×¢ ×¨×œ×•×•× ×˜×™")
                                except Exception as e:
                                    st.error(f"âŒ ×©×’×™××”: {str(e)}")
    
    else:  # General information mode
        st.info("ğŸ’¡ **×‘××¦×‘ ×–×” ××ª×” ×™×›×•×œ ×œ×©××•×œ ×©××œ×•×ª ×›×œ×œ×™×•×ª ×¢×œ ×‘×™×˜×•×—×™× ×œ×œ× ×¦×•×¨×š ×‘×¤×•×œ×™×¡×•×ª**")
        
        # Optional: Select specific companies to compare
        with st.expander("ğŸ¢ ×”×©×•×•×” ×—×‘×¨×•×ª ×¡×¤×¦×™×¤×™×•×ª (××•×¤×¦×™×•× ×œ×™)"):
            selected_companies = st.multiselect(
                "×‘×—×¨ ×—×‘×¨×•×ª ×œ×”×©×•×•××”:",
                COMPANIES,
                help="×”×©××¨ ×¨×™×§ ×œ×©××œ×” ×›×œ×œ×™×ª ×¢×œ ×›×œ ×”×©×•×§"
            )
        
        # Example questions
        with st.expander("ğŸ“ ×“×•×’×××•×ª ×œ×©××œ×•×ª"):
            st.markdown("""
            - ××” ×”×”×‘×“×œ ×‘×™×Ÿ ××’×“×œ ×œ×”×¨××œ ×‘×‘×™×˜×•×— ×‘×¨×™××•×ª?
            - ×›××” ×¢×•×œ×” ×‘×™×˜×•×— ×‘×¨×™××•×ª ××§×™×£ ×œ×’×™×œ 35?
            - ××” ×”×›×™×¡×•×™×™× ×”×—×©×•×‘×™× ×‘×™×•×ª×¨ ×‘×‘×™×˜×•×— ×‘×¨×™××•×ª?
            - ×”×× ×›×“××™ ×œ×”×•×¡×™×£ × ×¡×¤×— × ×™×ª×•×—×™× ×‘×—×•×´×œ?
            - ××”×Ÿ ×”×—×‘×¨×•×ª ×¢× ×”×©×™×¨×•×ª ×”×˜×•×‘ ×‘×™×•×ª×¨?
            - ×”×©×•×•××ª ××—×™×¨×™× ×‘×™×Ÿ ×”×—×‘×¨×•×ª ×”×’×“×•×œ×•×ª
            - ××” ×–×” × ×¡×¤×— ×××‘×•×œ×˜×•×¨×™ ×•×œ××” ×× ×™ ×¦×¨×™×š ××•×ª×•?
            """)
        
        query = st.text_area(
            "×©××œ ×©××œ×” ×›×œ×œ×™×ª:",
            placeholder="×œ×“×•×’××”: ××” ×”×”×‘×“×œ ×‘×™×Ÿ ××’×“×œ ×œ×”×¨××œ?",
            height=100
        )
        
        if st.button("ğŸ” ×©××œ", type="primary") and query:
            # Re-initialize Claude
            api_key = st.secrets.get("ANTHROPIC_API_KEY") or os.getenv("ANTHROPIC_API_KEY", "").strip()
            if not api_key:
                st.error("âŒ API key not configured")
            else:
                try:
                    fresh_claude = Anthropic(api_key=api_key)
                except Exception as e:
                    st.error(f"âŒ Failed to initialize Claude: {str(e)}")
                    fresh_claude = None
                
                if fresh_claude:
                    with st.spinner("××—×¤×© ××™×“×¢..."):
                        try:
                            # Build context with company info if specific companies selected
                            company_context = ""
                            if selected_companies:
                                company_context = "\n\n××™×“×¢ ×¢×œ ×”×—×‘×¨×•×ª ×©× ×‘×—×¨×•:\n"
                                for company in selected_companies:
                                    if company in COMPANIES_INFO:
                                        info = COMPANIES_INFO[company]
                                        company_context += f"""
\n{company} ({info['full_name']}):
- ××ª×¨: {info['website']}
- ×˜×œ×¤×•×Ÿ: {info['phone']}
- ×™×ª×¨×•× ×•×ª: {', '.join(info['strengths'])}
- ×™×“×•×¢×” ×‘: {', '.join(info['known_for'])}
"""
                            
                            # Add nispach info if question mentions specific nispach
                            nispach_numbers = extract_nispach_numbers(query)
                            nispach_context = ""
                            
                            if nispach_numbers:
                                st.info(f"ğŸ” ×–×™×”×™×ª×™ ×©××œ×” ×¢×œ × ×¡×¤×—×™×: {', '.join(nispach_numbers)}")
                                for nispach_num in nispach_numbers:
                                    nispach_data = get_nispach_info_with_search(
                                        nispach_number=nispach_num,
                                        use_online_search=False,  # Don't search web for general mode
                                        anthropic_client=fresh_claude
                                    )
                                    if nispach_data and not nispach_data.get('unknown'):
                                        nispach_context += f"""
\n××™×“×¢ ×¢×œ × ×¡×¤×— {nispach_num} - {nispach_data['name']}:
×ª×™××•×¨: {nispach_data['description']}
"""
                                        if nispach_data.get('includes'):
                                            nispach_context += f"×›×•×œ×œ: {', '.join(nispach_data['includes'])}\n"
                            
                            system_prompt = """××ª×” ×™×•×¢×¥ ×‘×™×˜×•×— ××§×¦×•×¢×™ ×™×©×¨××œ×™. ×ª×¤×§×™×“×š ×œ×¡×¤×§ ××™×“×¢ ×›×œ×œ×™ ×•××§×¦×•×¢×™ ×¢×œ ×‘×™×˜×•×—×™×.

×›×œ×œ×™×:
1. ×¡×¤×§ ××™×“×¢ ××‘×•×¡×¡ ×¢×œ ×”×™×“×¢ ×©×œ×š ×•×¢×œ ×”××™×“×¢ ×©× ××¡×¨ ×œ×š
2. ×× ××“×•×‘×¨ ×‘×”×©×•×•××” ×‘×™×Ÿ ×—×‘×¨×•×ª - ×”×™×” ××•×‘×™×™×§×˜×™×‘×™
3. ×”×¡×‘×¨ ××•×©×’×™× ×‘×¦×•×¨×” ×¤×©×•×˜×” ×•×‘×¨×•×¨×”
4. ×¦×™×™×Ÿ ×× ×”××™×“×¢ ×”×•× ×›×œ×œ×™ ××• ××©×ª× ×” ×‘×™×Ÿ ×—×‘×¨×•×ª
5. ×”××œ×¥ ×ª××™×“ ×œ×‘×“×•×§ ×¢× ×—×‘×¨×ª ×”×‘×™×˜×•×— ××ª ×”×¤×¨×˜×™× ×”××“×•×™×§×™×
6. ×× ×™×© ××™×“×¢ ×¢×œ ××—×™×¨×™× - ×ª×Ÿ ×˜×•×•×—×™× ×›×œ×œ×™×™×
7. ×”×“×’×© ××ª ×”× ×§×•×“×•×ª ×”×—×©×•×‘×•×ª ×‘×™×•×ª×¨
8. ×¢× ×” ×‘×¢×‘×¨×™×ª ×¤×©×•×˜×” ×•×‘×¨×•×¨×”

×¤×•×¨××˜ ×ª×©×•×‘×” ××•××œ×¥:
### ğŸ“‹ ×ª×©×•×‘×”
[×ª×©×•×‘×” ×™×©×™×¨×” ×œ×©××œ×”]

### ğŸ’¡ ××™×“×¢ × ×•×¡×£
[×¤×¨×˜×™× ×¨×œ×•×•× ×˜×™×™× × ×•×¡×¤×™×]

### âš ï¸ ×—×©×•×‘ ×œ×–×›×•×¨
[× ×§×•×“×•×ª ×—×©×•×‘×•×ª ×œ×”×ª×™×™×—×¡×•×ª]"""
                            
                            user_content = f"""×©××œ×”: {query}
{company_context}
{nispach_context}

×¢× ×” ×¢×œ ×”×©××œ×” ×‘×¦×•×¨×” ××§×¦×•×¢×™×ª ×•××¤×•×¨×˜×ª. ×× ×™×© ××™×“×¢ ×¡×¤×¦×™×¤×™ ×¢×œ ×—×‘×¨×•×ª ××• × ×¡×¤×—×™× - ×©×œ×‘ ××•×ª×• ×‘×ª×©×•×‘×”."""
                            
                            response = fresh_claude.messages.create(
                                model="claude-sonnet-4-20250514",
                                max_tokens=2000,
                                system=system_prompt,
                                messages=[{"role": "user", "content": user_content}]
                            )
                            
                            answer = response.content[0].text
                            st.markdown("### ğŸ’¡ ×ª×©×•×‘×”:")
                            st.success(answer)
                            
                            # Save to history with special marker for general questions
                            db.save_qa(st.session_state.current_investigation_id, query, answer, ["××™×“×¢ ×›×œ×œ×™"])
                            
                        except Exception as e:
                            st.error(f"âŒ ×©×’×™××”: {str(e)}")
                            import traceback
                            st.code(traceback.format_exc())

elif st.session_state.page == "ğŸ“š ××“×¨×™×š × ×¡×¤×—×™×":
    st.title("ğŸ“š ××“×¨×™×š × ×¡×¤×—×™× - ××” ×›×œ × ×¡×¤×— ××›×¡×”?")
    st.write("××™×“×¢ ××¤×•×¨×˜ ×¢×œ × ×¡×¤×—×™× × ×¤×•×¦×™× ×‘×¤×•×œ×™×¡×•×ª ×‘×™×˜×•×— ×‘×¨×™××•×ª")
    
    # UPDATED: Show new count
    st.info(f"ğŸ“Š **×‘×××’×¨ ×©×œ× ×• ×™×© ××™×“×¢ ×¢×œ {len(NISPACH_INFO_EXPANDED)} × ×¡×¤×—×™×!**")
    st.caption("ğŸ’¡ ×× × ×¡×¤×— ×œ× × ××¦× ×‘×××’×¨ - × ×—×¤×© ××•×ª×• ×‘××™× ×˜×¨× ×˜ ××•×˜×•××˜×™×ª!")
    
    st.markdown("---")
    
    search_term = st.text_input("ğŸ” ×—×¤×© × ×¡×¤×— ×œ×¤×™ ××¡×¤×¨ ××• ×©×:", placeholder="×œ×“×•×’××”: 8713 ××• ××‘×—× ×” ××”×™×¨×”")
    
    if search_term:
        found_nispachim = []
        search_lower = search_term.lower()
        
        # UPDATED: Search in expanded database
        for nispach_num, data in NISPACH_INFO_EXPANDED.items():
            if (search_term in nispach_num or 
                search_lower in data['name'].lower() or 
                search_lower in data['description'].lower()):
                found_nispachim.append((nispach_num, data))
        
        if found_nispachim:
            st.success(f"âœ… × ××¦××• {len(found_nispachim)} ×ª×•×¦××•×ª ×‘×××’×¨ ×”××§×•××™:")
            for nispach_num, data in found_nispachim:
                with st.expander(f"ğŸ“‹ × ×¡×¤×— {nispach_num} - {data['name']}", expanded=True):
                    st.markdown(f"**×ª×™××•×¨:** {data['description']}")
                    
                    if 'includes' in data:
                        st.markdown("**×›×•×œ×œ:**")
                        for item in data['includes']:
                            st.markdown(f"- {item}")
                    
                    if 'reimbursement' in data:
                        st.markdown("**ğŸ’° ×©×™×¢×•×¨×™ ×”×—×–×¨:**")
                        for service, amount in data['reimbursement'].items():
                            st.markdown(f"- {service}: **{amount}**")
                    
                    if 'limits' in data:
                        st.markdown("**ğŸ“Š ××’×‘×œ×•×ª:**")
                        for limit_type, limit_value in data['limits'].items():
                            st.markdown(f"- {limit_type}: {limit_value}")
                    
                    if 'notes' in data:
                        st.info(f"ğŸ’¡ {data['notes']}")
        else:
            # NOT FOUND IN LOCAL DATABASE - TRY WEB SEARCH
            st.warning("âŒ ×œ× × ××¦× ×‘×××’×¨ ×”××§×•××™")
            
            # Extract digits from search term (handle cases like "6790?" or "× ×¡×¤×— 6790")
            digits_only = ''.join(filter(str.isdigit, search_term))
            
            # Debug info
            st.caption(f"ğŸ” DEBUG: ××¡×¤×¨ ×©×—×•×œ×¥ = '{digits_only}' (××•×¨×š: {len(digits_only)})")
            
            # Check if it looks like a nispach number (4-6 digits)
            if digits_only and len(digits_only) >= 4 and len(digits_only) <= 6:
                st.info(f"ğŸ” ××—×¤×© ××™×“×¢ ×¢×œ × ×¡×¤×— {digits_only} ×‘××™× ×˜×¨× ×˜...")
                
                # Debug: Check if claude_client exists
                if claude_client is None:
                    st.error("âŒ Claude API ×œ× ××—×•×‘×¨!")
                    st.info("ğŸ”§ ×¤×ª×¨×•×Ÿ: ×‘×“×•×§ ××ª ×”-ANTHROPIC_API_KEY ×‘×”×’×“×¨×•×ª Streamlit Cloud")
                else:
                    st.success("âœ… Claude API ××—×•×‘×¨ - ××ª×—×™×œ ×—×™×¤×•×©...")
                    
                    with st.spinner(f"××—×¤×© ×‘××™× ×˜×¨× ×˜..."):
                        try:
                            web_result = get_nispach_info_with_search(
                                nispach_number=digits_only,
                                use_online_search=True,
                                anthropic_client=claude_client
                            )
                            
                            if web_result and not web_result.get('unknown'):
                                st.success("âœ… × ××¦× ××™×“×¢ ×‘××™× ×˜×¨× ×˜!")
                                formatted = format_nispach_response(web_result)
                                st.markdown(formatted)
                            else:
                                st.error(f"âŒ ×œ× ×”×¦×œ×—× ×• ×œ××¦×•× ××™×“×¢ ×¢×œ × ×¡×¤×— {digits_only}")
                                st.info("ğŸ’¡ **×¢×¦×•×ª:**\n- × ×¡×” ×œ×—×¤×© ×‘××ª×¨ ×—×‘×¨×ª ×”×‘×™×˜×•×—\n- ×¦×•×¨ ×§×©×¨ ×¢× × ×¦×™×’ ×”×‘×™×˜×•×—\n- ×‘×“×•×§ ×× ××¡×¤×¨ ×”× ×¡×¤×— × ×›×•×Ÿ")
                        except Exception as e:
                            st.error(f"âŒ ×©×’×™××” ×‘×—×™×¤×•×©: {str(e)}")
            else:
                st.info("ğŸ’¡ × ×¡×” ×œ×—×¤×© ×œ×¤×™ ××¡×¤×¨ × ×¡×¤×— (4-6 ×¡×¤×¨×•×ª)\n\n×“×•×’×××•×ª: 8713, 5409, 6792")
    
    st.markdown("---")
    st.markdown("### ğŸ“‘ ×¨×©×™××ª ×›×œ ×”× ×¡×¤×—×™× ×‘×××’×¨")
    
    # Show all nispachim
    all_nispachim = get_all_known_nispachim()
    nispach_list = "\n".join([f"- **{num}**: {NISPACH_INFO_EXPANDED[num]['name']}" 
                              for num in all_nispachim])
    st.markdown(nispach_list)

elif st.session_state.page == "âš–ï¸ ×”×©×•×•××”":
    st.title("âš–ï¸ ×”×©×•×•××”")
    policies = db.get_policies(st.session_state.current_investigation_id)
    
    if len(policies) < 2:
        st.warning("âš ï¸ ×”×¢×œ×” ×œ×¤×—×•×ª 2 ×¤×•×œ×™×¡×•×ª")
    else:
        policy_options = {pol['custom_name']: pol['id'] for pol in policies}
        selected_names = st.multiselect("×‘×—×¨ ×¤×•×œ×™×¡×•×ª:", list(policy_options.keys()), 
                                       default=list(policy_options.keys())[:2])
        
        if len(selected_names) >= 2:
            if st.button("ğŸ” ×”×©×•×•×”", type="primary"):
                # Comparison logic...
                st.info("××›×™×Ÿ ×”×©×•×•××”...")

elif st.session_state.page == "ğŸ“œ ×”×™×¡×˜×•×¨×™×”":
    st.title("ğŸ“œ ×”×™×¡×˜×•×¨×™×”")
    history = db.get_qa_history(st.session_state.current_investigation_id)
    
    if history:
        for idx, (question, answer, policy_names_json, created_at) in enumerate(history, 1):
            try:
                policies = json.loads(policy_names_json)
                pol_str = ", ".join(policies)
            except:
                pol_str = ""
            
            with st.expander(f"{idx}. {question[:60]}..."):
                if pol_str:
                    st.caption(f"×¤×•×œ×™×¡×•×ª: {pol_str}")
                st.success(answer)
    else:
        st.info("××™×Ÿ ×”×™×¡×˜×•×¨×™×”")

elif st.session_state.page == "ğŸ‘‘ × ×™×”×•×œ":
    if st.session_state.username != "admin":
        st.error("â›” ××™×Ÿ ×œ×š ×”×¨×©××”")
        st.stop()
    
    st.title("ğŸ‘‘ ×¤×× ×œ × ×™×”×•×œ")
    st.info("××™×“×¢ ×–××™×Ÿ ×¨×§ ×œ×× ×”×œ")

st.markdown("---")
st.caption(f"××¢×¨×›×ª ×”×©×•×•××ª ×¤×•×œ×™×¡×•×ª v3.1 | ××©×ª××©: {st.session_state.username} | {len(NISPACH_INFO_EXPANDED)} × ×¡×¤×—×™× ×‘×××’×¨")
